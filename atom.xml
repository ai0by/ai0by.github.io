<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>风向标 | 分享与创造</title>
  
  
  <link href="/atom.xml" rel="self"/>
  
  <link href="https://sbcoder.cn/"/>
  <updated>2020-06-06T07:02:10.746Z</updated>
  <id>https://sbcoder.cn/</id>
  
  <author>
    <name>ai0by</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>MAC环境记录</title>
    <link href="https://sbcoder.cn/2020/06/06/myMacOptionPHP.html"/>
    <id>https://sbcoder.cn/2020/06/06/myMacOptionPHP.html</id>
    <published>2020-06-06T06:36:36.000Z</published>
    <updated>2020-06-06T07:02:10.746Z</updated>
    
    <content type="html"><![CDATA[<div id="hexo-blog-encrypt" data-wpm="Oh, this is an invalid password. Check and try again, please." data-whm="OOPS, these decrypted content may changed, but you can still have a look.">  <div class="hbe-input-container">  <input type="password" id="hbePass" placeholder="" />    <label for="hbePass">Hey, password is required here.</label>    <div class="bottom-line"></div>  </div>  <script id="hbeData" type="hbeData" data-hmacdigest="a3f06f555213340cc384d95a014fa4c3800074c1343a9e088364913f795e2d9d">91380cc92a8d30e36eb1f29d05848a5d07f25252816ad7ebdd15eaa580161fc44b711c0fe0b732c54b8c630c92cd3a0206debdf80f9500f81c9eda0038afaa5abaa98e3da8cf435050088541e23c5f09c6b66320a9dca7ba2d391c392b3066757bce8ceb433e29d6eabf9502c31b1a865ce8ce26480c2b3651a02d74e0a7ce70a9ee5b6db44a1870e6ca7aedf4b00f3cec043c7152d98d61a1212fd13720055687b3ce39ae15f81099f94d6605933adc2204646f0187888f5c136e52f8cb04cd796bd502bac4627540219996cb70fccd8388bf36e721dd6f8349cba819a6d88d4f667de02092412f91d84766b8a2280a422fb7e70e0bc39bcae798ac747012e6e2ed57cf472e34826a304e9bd829faacaf317c5fef9e039c1227efa0bf03ecfdb9c87b1bcd896d31ad99aa235eb299d35cbf1a894fe489def3e2a66045caed009655475f4cc8603da3b9b3b2588e762efa626956773e907abf3d5516c0930efee901b143f924f0b2e77c4da40a1d5086a47b83e1325cd908837e451ec35585b8d2e09830865a0fbc72458d93d95bf1f8041d481121707cae85725ea177ac082f7eb4a2d108faa22b2d8656af906db054f592b7000c9651c9f7c203cc53b117c1484ee0b76587256a21893f81233c2c59ee8b8e55d27cad982d8e4e3ebfcae1c52307f6646a344b171657c6692e26d1c82136fb2cef78d3fc794121af3f0bb203abc2aa315c9a2d064a929e87f3bd604769693e87d62e5f6c4584f54148bd89faec4771aec625c9a3a4bbb07751b69b44c7f064379815bc2b509aedc1a02db3026bdc3319ebbfe2e6ebcad9f2bba9a7884feed4a0f8492374237b7692e7a8017c3bf2ace473be6d847ee17d89e69691c663d16fc07f52cd866a6b8e924114a5fd3d82f1f57b7e4ce0163e8e8812bbd5e6f25cdc72110de39baeea10209a556ed0b4eb2b0c28b3c41afca7281df22cf43ae34e23891088e886296772e155586d46de30ee6a30f9421962e440b7cbd4641c9beeec5e11aa4693b86797a9b2b84f0797cd524a00b80e80244bb3b8667fb0bdd69e6ef02585e0fe61cbbc3f09c57311ad3ad3d427d29aef76fc1f2400ec63b32f93922919c9c3cbd552404ecc32b077d9ae759b439e39a8a282b1a1708e231e</script></div><script src="/lib/blog-encrypt.js"></script><link href="/css/blog-encrypt.css" rel="stylesheet" type="text/css">]]></content>
    
    <summary type="html">
    
      Here&#39;s something encrypted, password is required to continue reading.
    
    </summary>
    
      <category term="note" scheme="https://sbcoder.cn/categories/note/"/>
    
    
      <category term="笔记" scheme="https://sbcoder.cn/tags/%E7%AC%94%E8%AE%B0/"/>
    
  </entry>
  
  <entry>
    <title>ElasticSearch &amp; ELK日志分析 从零开始搭建到使用</title>
    <link href="https://sbcoder.cn/2020/05/27/ELK_Stack.html"/>
    <id>https://sbcoder.cn/2020/05/27/ELK_Stack.html</id>
    <published>2020-05-27T12:34:16.000Z</published>
    <updated>2020-06-04T08:31:49.232Z</updated>
    
    <content type="html"><![CDATA[<h2 id="引言"><a href="#引言" class="headerlink" title="引言"></a>引言</h2><h3 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h3><p>基于Lucene的搜索服务器，它提供了一个分布式多用户能力的全文搜索引擎，基于RESTful web接口。<br>更适用于集群部署，适合各类 分词，全文搜索，通过建立索引（分片，按节点分片）来实现更快的搜索<br>Elasticsearch是与Logstash的数据收集和日志解析引擎以及Kibana的分析和可视化平台一起开发的。这三个产品被设计成一个集成解决方案，称为“Elastic Stack”（以前称为“ELK stack”）。<br>本文只做单节点运行</p><figure class="image-bubble">                <div class="img-lightbox">                    <div class="overlay"></div>                    <img src="https://s1.ax1x.com/2020/06/03/tU7KfS.png" alt="ELK.png" title>                </div>                <div class="image-caption">ELK.png</div>            </figure><h3 id="官方介绍"><a href="#官方介绍" class="headerlink" title="官方介绍"></a>官方介绍</h3><blockquote><p>Elasticsearch 是一个分布式、RESTful 风格的搜索和数据分析引擎，能够解决不断涌现出的各种用例。 作为 Elastic Stack 的核心，它集中存储您的数据，帮助您发现意料之中以及意料之外的情况。</p></blockquote><h3 id="注意事项"><a href="#注意事项" class="headerlink" title="注意事项"></a>注意事项</h3><ul><li>单点服务器维持稳定可能需要常驻内存 4G 以上</li><li>单点ELK维持稳定可能需要CPU 4核心 以上</li></ul><h3 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h3><ul><li><a href="https://www.cnblogs.com/fbtop/p/11005469.html" target="_blank" rel="noopener">Docker安装部署ELK教程 (Elasticsearch+Kibana+Logstash+Filebeat)</a></li><li><a href="https://zhang.ge/5135.html" target="_blank" rel="noopener">零门槛！基于Docker快速部署ES集群</a></li></ul><h2 id="下载集群所需镜像-zookeeper-kafka"><a href="#下载集群所需镜像-zookeeper-kafka" class="headerlink" title="下载集群所需镜像 zookeeper kafka"></a>下载集群所需镜像 zookeeper kafka</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker pull zookeeper</span><br><span class="line">docker pull wurstmeister/kafka</span><br></pre></td></tr></table></figure><h2 id="单节点无内网IP使用"><a href="#单节点无内网IP使用" class="headerlink" title="单节点无内网IP使用"></a>单节点无内网IP使用</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker network create elkwork</span><br></pre></td></tr></table></figure><p>创建内部网络后在每次 docker run 的时候 增加参数 <code>--net elkwork</code></p><h2 id="elastic相关"><a href="#elastic相关" class="headerlink" title="elastic相关"></a>elastic相关</h2><ul><li><p>旧版本</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker pull docker.elastic.co/elasticsearch/elasticsearch:5.6.8</span><br><span class="line">docker pull docker.elastic.co/kibana/kibana:5.6.8</span><br><span class="line">docker pull docker.elastic.co/logstash/logstash:5.6.8</span><br></pre></td></tr></table></figure></li><li><p>新版本</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">docker pull docker.elastic.co/elasticsearch/elasticsearch:7.7.0</span><br><span class="line">docker pull docker.elastic.co/kibana/kibana:7.7.0</span><br><span class="line">docker pull docker.elastic.co/logstash/logstash:7.7.0</span><br><span class="line">docker pull store/elastic/filebeat:7.7.0</span><br></pre></td></tr></table></figure></li></ul><h2 id="启动elasticsearch-自行替换版本"><a href="#启动elasticsearch-自行替换版本" class="headerlink" title="启动elasticsearch 自行替换版本"></a>启动elasticsearch 自行替换版本</h2><p><code>&quot;discovery.type=single-node&quot;</code> 单节点<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -d --name elasticsearch -p 9200:9200 -p 9300:9300 -e &quot;discovery.type=single-node&quot; docker.elastic.co/elasticsearch/elasticsearch:5.6.8</span><br></pre></td></tr></table></figure></p><p>默认用户名            默认密码<br>elastic                changeme                 </p><p>测试是否已经连通<code>-u elastic:changeme</code> 验权<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -u elastic:changeme localhost:9200</span><br></pre></td></tr></table></figure></p><p>浏览器端口访问测试<br><figure class="image-bubble">                <div class="img-lightbox">                    <div class="overlay"></div>                    <img src="https://s1.ax1x.com/2020/05/27/tAsJj1.png" alt="elasticsearch.png" title>                </div>                <div class="image-caption">elasticsearch.png</div>            </figure></p><h2 id="elasticsearch-各类语法"><a href="#elasticsearch-各类语法" class="headerlink" title="elasticsearch 各类语法"></a>elasticsearch 各类语法</h2><h3 id="基本"><a href="#基本" class="headerlink" title="基本"></a>基本</h3><p>浏览器访问<br><code>http://xxx.xx.xxx.xx:9200/_cat/indices?v</code>  查看当前节点的所有 Index<br><code>http://xxx.xx.xxx.xx:9200/_mapping?pretty=true</code>  列出每个 Index 所包含的 Type</p><p>验权机制增加参数  <code>-u elastic:changeme</code> 验权</p><p>命令行访问<br><code>curl -u elastic:changeme -X PUT &#39;localhost:9200/weather&#39;</code> 可以直接向 Elastic 服务器发出 PUT 请求<br><code>curl -u elastic:changeme -X DELETE &#39;localhost:9200/weather&#39;</code>  发出 DELETE 请求，删除这个 Index</p><h3 id="插入数据"><a href="#插入数据" class="headerlink" title="插入数据"></a>插入数据</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">curl -X POST &apos;localhost:9200/account/person&apos; -d &apos;</span><br><span class="line">&#123;</span><br><span class="line">  &quot;user&quot;: &quot;李四&quot;,</span><br><span class="line">  &quot;title&quot;: &quot;工程师&quot;,</span><br><span class="line">  &quot;desc&quot;: &quot;系统管理&quot;</span><br><span class="line">&#125;&apos;</span><br></pre></td></tr></table></figure><h3 id="读取数据"><a href="#读取数据" class="headerlink" title="读取数据"></a>读取数据</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl &apos;localhost:9200/account/person/1?pretty=true&apos;</span><br></pre></td></tr></table></figure><p>示例</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"_index"</span> : <span class="string">"accounts"</span>,</span><br><span class="line">  <span class="attr">"_type"</span> : <span class="string">"person"</span>,</span><br><span class="line">  <span class="attr">"_id"</span> : <span class="string">"1"</span>,</span><br><span class="line">  <span class="attr">"_version"</span> : <span class="number">1</span>,</span><br><span class="line">  <span class="attr">"found"</span> : <span class="literal">true</span>,</span><br><span class="line">  <span class="attr">"_source"</span> : &#123;</span><br><span class="line">    <span class="attr">"user"</span> : <span class="string">"张三"</span>,</span><br><span class="line">    <span class="attr">"title"</span> : <span class="string">"工程师"</span>,</span><br><span class="line">    <span class="attr">"desc"</span> : <span class="string">"数据库管理"</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="删除记录"><a href="#删除记录" class="headerlink" title="删除记录"></a>删除记录</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -X DELETE &apos;localhost:9200/accounts/person/1&apos;</span><br></pre></td></tr></table></figure><h3 id="更新记录"><a href="#更新记录" class="headerlink" title="更新记录"></a>更新记录</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">curl -X PUT &apos;localhost:9200/accounts/person/1&apos; -d &apos;</span><br><span class="line">&#123;</span><br><span class="line">    &quot;user&quot; : &quot;张三&quot;,</span><br><span class="line">    &quot;title&quot; : &quot;工程师&quot;,</span><br><span class="line">    &quot;desc&quot; : &quot;数据库管理，软件开发&quot;</span><br><span class="line">&#125;&apos;</span><br></pre></td></tr></table></figure><h3 id="返回所有记录"><a href="#返回所有记录" class="headerlink" title="返回所有记录"></a>返回所有记录</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl &apos;localhost:9200/accounts/person/_search&apos;</span><br></pre></td></tr></table></figure><ul><li>索引 ：<code>/Index/Type/_search</code></li><li>total：返回记录数，本例是2条。</li><li>max_score：最高的匹配程度，本例是1.0。</li><li>hits：返回的记录组成的数组。</li></ul><h3 id="查询记录"><a href="#查询记录" class="headerlink" title="查询记录"></a>查询记录</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">curl &apos;localhost:9200/accounts/person/_search&apos;  -d &apos;</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot; : &#123; &quot;match&quot; : &#123; &quot;desc&quot; : &quot;软件 系统&quot; &#125;&#125;,</span><br><span class="line">  &quot;from&quot;: 1</span><br><span class="line">  &quot;size&quot;: 1</span><br><span class="line">&#125;&apos;</span><br></pre></td></tr></table></figure><ul><li>size 返回数量</li><li>from 开始位置</li><li>OR搜索，当前搜索的示例是 <code>软件</code>或<code>系统</code></li><li>AND搜索示例<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;bool&quot;: &#123;</span><br><span class="line">      &quot;must&quot;: [</span><br><span class="line">        &#123; &quot;match&quot;: &#123; &quot;desc&quot;: &quot;软件&quot; &#125; &#125;,</span><br><span class="line">        &#123; &quot;match&quot;: &#123; &quot;desc&quot;: &quot;系统&quot; &#125; &#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><h3 id="参考文章-1"><a href="#参考文章-1" class="headerlink" title="参考文章"></a>参考文章</h3><ul><li><a href="http://www.ruanyifeng.com/blog/2017/08/elasticsearch.html" target="_blank" rel="noopener">全文搜索引擎 Elasticsearch 入门教程</a></li></ul><h2 id="启动kibana-自行替换版本"><a href="#启动kibana-自行替换版本" class="headerlink" title="启动kibana 自行替换版本"></a>启动kibana 自行替换版本</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -d --name kibana -p 8001:5601 docker.elastic.co/kibana/kibana:5.6.8</span><br></pre></td></tr></table></figure><p>kibana 容器内部修改配置ip<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Vi ./config/kibana.yml</span><br></pre></td></tr></table></figure></p><p>重启容器使配置生效</p><figure class="image-bubble">                <div class="img-lightbox">                    <div class="overlay"></div>                    <img src="https://s1.ax1x.com/2020/05/27/tAsApj.png" alt="kibana.png" title>                </div>                <div class="image-caption">kibana.png</div>            </figure><h2 id="配置-logstash"><a href="#配置-logstash" class="headerlink" title="配置 logstash"></a>配置 logstash</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mkdir /home/tjy/docker/logstash/</span><br><span class="line">mkdir /home/tjy/docker/logstash/conf.d/</span><br><span class="line">vi /home/tjy/docker/logstash/logstash.yml</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">path.config: /usr/share/logstash/conf.d/*.conf</span><br><span class="line">path.logs: /var/log/logstash</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vi /home/tjy/docker/logstash/conf.d/test.conf</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">input &#123;</span><br><span class="line">    beats &#123;</span><br><span class="line">    port =&gt; 5044</span><br><span class="line">    codec =&gt; &quot;json&quot;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">output &#123;</span><br><span class="line">  elasticsearch &#123; </span><br><span class="line">hosts =&gt; [&quot;xxx.xx.xxx.xx:9200&quot;]</span><br><span class="line">user =&gt; elastic </span><br><span class="line">    password =&gt; changeme </span><br><span class="line">&#125;</span><br><span class="line">  stdout &#123; codec =&gt; rubydebug &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="启动logstash并挂载"><a href="#启动logstash并挂载" class="headerlink" title="启动logstash并挂载"></a>启动logstash并挂载</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -it -d -p 8011:5044 -p 9600:9600 --name logstash -v /home/tjy/docker/logstash/logstash.yml:/usr/share/logstash/config/logstash.yml -v /home/tjy/docker/logstash/conf.d/:/usr/share/logstash/conf.d/ docker.elastic.co/logstash/logstash:5.6.8</span><br></pre></td></tr></table></figure><h2 id="配置-filebeat"><a href="#配置-filebeat" class="headerlink" title="配置 filebeat"></a>配置 filebeat</h2><p>下载 通用配置文件</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mkdir /Users/XXX/Downloads/Docker/filebeat/</span><br><span class="line">cd /Users/XXX/Downloads/Docker/filebeat</span><br><span class="line">wget https://raw.githubusercontent.com/elastic/beats/7.1/deploy/docker/filebeat.docker.yml</span><br><span class="line">vi filebeat.docker.yml</span><br></pre></td></tr></table></figure><p>配置监听 Nginx log</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">filebeat.config:</span><br><span class="line">  modules:</span><br><span class="line">    path: $&#123;path.config&#125;/modules.d/*.yml</span><br><span class="line">    reload.enabled: false</span><br><span class="line"></span><br><span class="line">filebeat.autodiscover:</span><br><span class="line">  providers:</span><br><span class="line">    - type: docker</span><br><span class="line">      hints.enabled: true</span><br><span class="line"></span><br><span class="line">processors:</span><br><span class="line">- add_cloud_metadata: ~</span><br><span class="line"></span><br><span class="line">filebeat.inputs:</span><br><span class="line">- type: log</span><br><span class="line">  enabled: true</span><br><span class="line">  paths:</span><br><span class="line">  - /var/log/nginx/*.log</span><br><span class="line"></span><br><span class="line">output.logstash:</span><br><span class="line">  hosts: [&apos;logstash:5044&apos;]</span><br></pre></td></tr></table></figure><h2 id="filebeat-配合-logstash-挂载并启动"><a href="#filebeat-配合-logstash-挂载并启动" class="headerlink" title="filebeat 配合 logstash 挂载并启动"></a>filebeat 配合 logstash 挂载并启动</h2><p>以下映射的路径为我自己电脑的路径，需要自行修改！<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run --name filebeat --user=root -d --net elkwork -v /usr/local/var/log/nginx/:/var/log/nginx/ -v /Users/XXX/Downloads/Docker/filebeat/filebeat.docker.yml:/usr/share/filebeat/filebeat.yml -v /var/run/docker.sock:/var/run/docker.sock store/elastic/filebeat:7.7.0</span><br></pre></td></tr></table></figure></p><figure class="image-bubble">                <div class="img-lightbox">                    <div class="overlay"></div>                    <img src="https://s1.ax1x.com/2020/06/03/tUHz8O.png" alt="success.png" title>                </div>                <div class="image-caption">success.png</div>            </figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;引言&quot;&gt;&lt;a href=&quot;#引言&quot; class=&quot;headerlink&quot; title=&quot;引言&quot;&gt;&lt;/a&gt;引言&lt;/h2&gt;&lt;h3 id=&quot;介绍&quot;&gt;&lt;a href=&quot;#介绍&quot; class=&quot;headerlink&quot; title=&quot;介绍&quot;&gt;&lt;/a&gt;介绍&lt;/h3&gt;&lt;p&gt;基于L
      
    
    </summary>
    
      <category term="架构" scheme="https://sbcoder.cn/categories/%E6%9E%B6%E6%9E%84/"/>
    
    
      <category term="ElasticSearch" scheme="https://sbcoder.cn/tags/ElasticSearch/"/>
    
      <category term="kibana" scheme="https://sbcoder.cn/tags/kibana/"/>
    
      <category term="Logstash" scheme="https://sbcoder.cn/tags/Logstash/"/>
    
  </entry>
  
  <entry>
    <title>Docker 安装 PHP-fpm</title>
    <link href="https://sbcoder.cn/2020/05/17/Docker_PHP_fpm.html"/>
    <id>https://sbcoder.cn/2020/05/17/Docker_PHP_fpm.html</id>
    <published>2020-05-17T04:54:47.000Z</published>
    <updated>2020-06-05T09:10:42.132Z</updated>
    
    <content type="html"><![CDATA[<h2 id="创建-uploads-ini"><a href="#创建-uploads-ini" class="headerlink" title="创建 uploads.ini"></a>创建 uploads.ini</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">file_uploads = On</span><br><span class="line">memory_limit = 64 M</span><br><span class="line">upload_max_filesize = 20M</span><br><span class="line">post_max_size = 20M</span><br><span class="line">max_execution_time = 600</span><br></pre></td></tr></table></figure><h2 id="创建-Dockerfile"><a href="#创建-Dockerfile" class="headerlink" title="创建 Dockerfile"></a>创建 Dockerfile</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">FROM php:7.3-fpm</span><br><span class="line"></span><br><span class="line">RUN apt-get update</span><br><span class="line">RUN apt-get install -y libwebp-dev libjpeg-dev libpng-dev libfreetype6-dev</span><br><span class="line"></span><br><span class="line">EXPOSE 9000</span><br><span class="line"></span><br><span class="line">#上传配置成20M</span><br><span class="line">COPY uploads.ini /usr/local/etc/php/conf.d</span><br><span class="line"></span><br><span class="line">RUN docker-php-ext-install mysqli</span><br><span class="line">RUN docker-php-ext-install pdo</span><br><span class="line">RUN docker-php-ext-install pdo_mysql</span><br><span class="line">RUN pecl install redis-4.2.0 &amp;&amp; docker-php-ext-enable redis</span><br><span class="line">RUN docker-php-ext-install bcmath</span><br><span class="line">RUN docker-php-ext-configure gd  --with-webp-dir=/usr/include/webp --with-png-dir=/usr/include --with-jpeg-dir=/usr/include --with-freetype-dir=/usr/include/freetype2</span><br><span class="line">RUN docker-php-ext-install gd</span><br></pre></td></tr></table></figure><h2 id="Docker-build"><a href="#Docker-build" class="headerlink" title="Docker build"></a>Docker build</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker build -t ai0by/php-fpm73:v1 .</span><br></pre></td></tr></table></figure><h2 id="运行容器"><a href="#运行容器" class="headerlink" title="运行容器"></a>运行容器</h2><p>挂载物理机内容到 容器内部 可以修改下方的 <code>/var/www/html/workspace</code> 为你的项目地址</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -v /var/www/html/workspace:/var/www/html/workspace  -p 9002:9000 -d php73:0.1</span><br></pre></td></tr></table></figure><h2 id="Nginx配置"><a href="#Nginx配置" class="headerlink" title="Nginx配置"></a>Nginx配置</h2><p>修改 <code>fastcgi_pass</code> 后面的 值为 <code>127.0.0.1:9002</code></p><p>LNMP用户 修改 <code>/usr/local/nginx/conf/enable-php-pathinfo.conf</code></p><p>将 <code>fastcgi_pass  unix:/tmp/php-cgi.sock;</code> 修改为 <code>fastcgi_pass  127.0.0.1:9002;</code></p><p>其他环境与此类似，直接改即可</p><h2 id="MySQL-Docker启动"><a href="#MySQL-Docker启动" class="headerlink" title="MySQL Docker启动"></a>MySQL Docker启动</h2><p>自行修改 挂载路径 以及 密码<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run --restart=always --name mysql5.7 -p 3306:3306 -v /Users/XXX/Downloads/Docker/mysql5.7:/var/lib/mysql -e MYSQL_ROOT_PASSWORD=123456 -d mysql:5.7 --character-set-server=utf8mb4 --collation-server=utf8mb4_unicode_ci</span><br></pre></td></tr></table></figure></p><p>Nginx 个人不习惯扔Docker中，因此暂时不管</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;创建-uploads-ini&quot;&gt;&lt;a href=&quot;#创建-uploads-ini&quot; class=&quot;headerlink&quot; title=&quot;创建 uploads.ini&quot;&gt;&lt;/a&gt;创建 uploads.ini&lt;/h2&gt;&lt;figure class=&quot;highlight 
      
    
    </summary>
    
      <category term="PHP" scheme="https://sbcoder.cn/categories/PHP/"/>
    
    
      <category term="fpm" scheme="https://sbcoder.cn/tags/fpm/"/>
    
      <category term="nginx" scheme="https://sbcoder.cn/tags/nginx/"/>
    
  </entry>
  
  <entry>
    <title>Workerman 适合PHPer使用的Socket通讯框架</title>
    <link href="https://sbcoder.cn/2020/05/14/workerman.html"/>
    <id>https://sbcoder.cn/2020/05/14/workerman.html</id>
    <published>2020-05-14T13:48:33.000Z</published>
    <updated>2020-05-14T13:51:53.699Z</updated>
    
    <content type="html"><![CDATA[<h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>适用于 客户端-服务端 客户端-客户端 一对多 多对多的关系，多个客户端之间的长连接通信，聊天室，在线客服，服务端反向推送播报消息</p><p>特性：多进程，长连接，高并发，常驻内存…</p><ul><li>客户端与worker进程<figure class="image-bubble">                <div class="img-lightbox">                    <div class="overlay"></div>                    <img src="https://s1.ax1x.com/2020/05/14/Y0lDgg.png" alt="客户端与worker进程.png" title>                </div>                <div class="image-caption">客户端与worker进程.png</div>            </figure></li><li>主进程与worker子进程<figure class="image-bubble">                <div class="img-lightbox">                    <div class="overlay"></div>                    <img src="https://s1.ax1x.com/2020/05/14/Y0lrvQ.png" alt="主进程与worker子进程.png" title>                </div>                <div class="image-caption">主进程与worker子进程.png</div>            </figure></li></ul><p>使用Workerman可以做很多有趣的事。（工业自动化，互联网工业，PLC机械报警…），通过长连接取数据，操作数据等，但PHP并不适用于工业领域。做一个仿im聊天工具，除了前端展示界面，后端也要考虑全面，更多的依赖于长连接。</p><p>本文参考 <a href="http://doc.workerman.net" target="_blank" rel="noopener">workerman官方文档</a><br>本文参考 <a href="https://github.com/hsu1943/thinksocketio" target="_blank" rel="noopener">thinksocketio - 基于socketio的聊天室Demo</a></p><h2 id="安装Workerman框架"><a href="#安装Workerman框架" class="headerlink" title="安装Workerman框架"></a>安装Workerman框架</h2><h3 id="服务端"><a href="#服务端" class="headerlink" title="服务端"></a>服务端</h3><p>创建一个文件夹 我这里使用 <code>testWebSocket</code><br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mkdir testWebSocket</span><br><span class="line">cd testWebSocket</span><br></pre></td></tr></table></figure></p><ul><li>git形式安装(推荐)<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git clone https://github.com/walkor/Workerman</span><br></pre></td></tr></table></figure></li></ul><p>根据官方文档创建一个示例 在 <code>testWebSocket</code> 下创建一个 PHP文件 test.php<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">use</span> <span class="title">Workerman</span>\<span class="title">Worker</span>;</span><br><span class="line"><span class="keyword">require_once</span> <span class="keyword">__DIR__</span> . <span class="string">'/Workerman/Autoloader.php'</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 注意：这里与上个例子不同，使用的是websocket协议</span></span><br><span class="line">$ws_worker = <span class="keyword">new</span> Worker(<span class="string">"websocket://0.0.0.0:2000"</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 启动4个进程对外提供服务</span></span><br><span class="line">$ws_worker-&gt;count = <span class="number">4</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 当收到客户端发来的数据后返回hello $data给客户端</span></span><br><span class="line">$ws_worker-&gt;onMessage = <span class="function"><span class="keyword">function</span><span class="params">($connection, $data)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 向客户端发送hello $data</span></span><br><span class="line">    $connection-&gt;send(<span class="string">'hello '</span> . $data);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 运行worker</span></span><br><span class="line">Worker::runAll()</span><br></pre></td></tr></table></figure></p><h3 id="前端测试"><a href="#前端测试" class="headerlink" title="前端测试"></a>前端测试</h3><p>前端测试例子代码 直接在Google浏览器执行<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">ws = <span class="keyword">new</span> WebSocket(<span class="string">"ws://127.0.0.1:2000"</span>);</span><br><span class="line">ws.onopen = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    alert(<span class="string">"连接成功"</span>);</span><br><span class="line">    ws.send(<span class="string">'tom'</span>);</span><br><span class="line">    alert(<span class="string">"给服务端发送一个字符串：tom"</span>);</span><br><span class="line">&#125;;</span><br><span class="line">ws.onmessage = <span class="function"><span class="keyword">function</span>(<span class="params">e</span>) </span>&#123;</span><br><span class="line">    alert(<span class="string">"收到服务端的消息："</span> + e.data);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p><h3 id="效果展示"><a href="#效果展示" class="headerlink" title="效果展示"></a>效果展示</h3><figure class="image-bubble">                <div class="img-lightbox">                    <div class="overlay"></div>                    <img src="https://s1.ax1x.com/2020/05/14/YBkdJA.png" alt="执行界面.png" title>                </div>                <div class="image-caption">执行界面.png</div>            </figure><figure class="image-bubble">                <div class="img-lightbox">                    <div class="overlay"></div>                    <img src="https://s1.ax1x.com/2020/05/14/YBkaid.png" alt="服务端界面.png" title>                </div>                <div class="image-caption">服务端界面.png</div>            </figure><h3 id="Workermen框架支持的协议"><a href="#Workermen框架支持的协议" class="headerlink" title="Workermen框架支持的协议"></a>Workermen框架支持的协议</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$websocket_worker = <span class="keyword">new</span> Worker(<span class="string">'websocket://0.0.0.0:2345'</span>);</span><br><span class="line"><span class="comment">// text协议</span></span><br><span class="line">$text_worker = <span class="keyword">new</span> Worker(<span class="string">'text://0.0.0.0:2346'</span>);</span><br><span class="line"><span class="comment">// frame协议</span></span><br><span class="line">$frame_worker = <span class="keyword">new</span> Worker(<span class="string">'frame://0.0.0.0:2347'</span>);</span><br><span class="line"><span class="comment">// tcp Worker，直接基于socket传输，不使用任何应用层协议</span></span><br><span class="line">$tcp_worker = <span class="keyword">new</span> Worker(<span class="string">'tcp://0.0.0.0:2348'</span>);</span><br><span class="line"><span class="comment">// udp Worker，不使用任何应用层协议</span></span><br><span class="line">$udp_worker = <span class="keyword">new</span> Worker(<span class="string">'udp://0.0.0.0:2349'</span>);</span><br><span class="line"><span class="comment">// unix domain Worker，不使用任何应用层协议</span></span><br><span class="line">$unix_worker = <span class="keyword">new</span> Worker(<span class="string">'unix:///tmp/wm.sock'</span>);</span><br></pre></td></tr></table></figure><h2 id="整合ThinkPHP"><a href="#整合ThinkPHP" class="headerlink" title="整合ThinkPHP"></a>整合ThinkPHP</h2><h3 id="说明"><a href="#说明" class="headerlink" title="说明"></a>说明</h3><p>Workermen是一个成熟的单独框架，在ThinkPHP中也可以使用Composer安装对应的扩展来使用，这里使用了针对PHP开发的扩展 PHPSocket.IO。<br>PHPSocket.IO设计的目标是利用PHP构建能够在不同浏览器和移动设备上良好运行的实时应用，如实时分析系统、在线聊天室、在线客服系统、评论系统、WebIM等。 PHPSocket.IO与workerman的区别是，PHPSocket.IO基于workerman开发，workerman有的特性PHPSocket.IO都支持。 PHPSocket.IO最大的优势是对各种浏览器的兼容性更好。</p><h3 id="安装及引用"><a href="#安装及引用" class="headerlink" title="安装及引用"></a>安装及引用</h3><p>使用Composer 安装对应的扩展<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">composer require workerman/phpsocket.io</span><br></pre></td></tr></table></figure></p><p>在编辑代码时引用对应的扩展即可<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> <span class="title">Workerman</span>\<span class="title">Worker</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">PHPSocketIO</span>\<span class="title">SocketIO</span>;</span><br></pre></td></tr></table></figure></p><h3 id="服务端-1"><a href="#服务端-1" class="headerlink" title="服务端"></a>服务端</h3><p>创建一个服务端 <code>application\socketio\controller\server.php</code><br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">app</span>\<span class="title">socketio</span>\<span class="title">controller</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Workerman</span>\<span class="title">Worker</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">PHPSocketIO</span>\<span class="title">SocketIO</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">think</span>\<span class="title">Db</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Server</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">index</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="comment">// 在2021端口创建服务</span></span><br><span class="line">        $io = <span class="keyword">new</span> SocketIO(<span class="number">2021</span>);</span><br><span class="line">        $io-&gt;on(<span class="string">'connection'</span>, <span class="function"><span class="keyword">function</span><span class="params">($socket)</span><span class="title">use</span><span class="params">($io)</span></span>&#123;</span><br><span class="line">            $socket-&gt;on(<span class="string">'chat message'</span>, <span class="function"><span class="keyword">function</span><span class="params">($msg)</span><span class="title">use</span><span class="params">($io)</span></span>&#123;</span><br><span class="line">                $io-&gt;emit(<span class="string">'chat message'</span>, $msg);</span><br><span class="line">            &#125;);</span><br><span class="line">            <span class="comment">// 监听到新的客户端连接即在服务端输出'new connection'</span></span><br><span class="line">            <span class="keyword">echo</span> <span class="string">'new connection'</span>.<span class="string">"\n"</span>;</span><br><span class="line">            <span class="comment">// 并向服务端发送'连接成功'</span></span><br><span class="line">            $socket-&gt;emit(<span class="string">'success'</span>, <span class="string">'连接成功'</span>);</span><br><span class="line">            <span class="comment">// 服务端发送消息过来</span></span><br><span class="line">            $socket-&gt;on(<span class="string">'sendMsg'</span>, <span class="function"><span class="keyword">function</span><span class="params">($msg)</span><span class="title">use</span><span class="params">($io)</span></span>&#123;</span><br><span class="line">                <span class="comment">// 在服务端输出消息</span></span><br><span class="line">                <span class="keyword">echo</span> $msg.<span class="string">"\n"</span>;</span><br><span class="line">                <span class="comment">// 在收到的消息前面拼接'收到'后向客户端发送回去</span></span><br><span class="line">                $io-&gt;emit(<span class="string">'sendMsg'</span>, <span class="string">'收到"'</span>.$msg.<span class="string">'"'</span>);</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="comment">// 启动服务</span></span><br><span class="line">        Worker::runAll();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>由于 Workermen 是一个独立于PHP程序使用的单一文件，需要单独用一个命令行来启动的，他完全可以独立使用，因此并不推荐使用TP框架来整合，但如果有这个需求，也可以在 <code>/public</code>目录下生成一个文件来绑定控制器，例如绑定 到 <code>socketio/Server</code><br>创建文件 <code>public/server.php</code> , 输入以下内容<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">// [ 应用入口文件 ]</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">think</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 加载基础文件</span></span><br><span class="line"><span class="keyword">require</span> <span class="keyword">__DIR__</span> . <span class="string">'/../thinkphp/base.php'</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 执行应用并响应（绑定）</span></span><br><span class="line">Container::get(<span class="string">'app'</span>)-&gt;bind(<span class="string">'socketio/Server'</span>)-&gt;run()-&gt;send();</span><br></pre></td></tr></table></figure></p><p>执行时 直接在Shell中运行该PHP文件即可，剩下的交给TP的机制<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd /public</span><br><span class="line">php server.php</span><br></pre></td></tr></table></figure></p><figure class="image-bubble">                <div class="img-lightbox">                    <div class="overlay"></div>                    <img src="https://s1.ax1x.com/2020/05/14/Y0J6AA.png" alt="执行结果.png" title>                </div>                <div class="image-caption">执行结果.png</div>            </figure><h2 id="结语"><a href="#结语" class="headerlink" title="结语"></a>结语</h2><p>根据通信行为可以衍生出各类应用，目前websocket已经是各大公司都需要的技术，会websocket就多了一份机会！</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;简介&quot;&gt;&lt;a href=&quot;#简介&quot; class=&quot;headerlink&quot; title=&quot;简介&quot;&gt;&lt;/a&gt;简介&lt;/h2&gt;&lt;p&gt;适用于 客户端-服务端 客户端-客户端 一对多 多对多的关系，多个客户端之间的长连接通信，聊天室，在线客服，服务端反向推送播报消息&lt;/p&gt;

      
    
    </summary>
    
      <category term="PHP" scheme="https://sbcoder.cn/categories/PHP/"/>
    
    
      <category term="socket" scheme="https://sbcoder.cn/tags/socket/"/>
    
      <category term="通讯" scheme="https://sbcoder.cn/tags/%E9%80%9A%E8%AE%AF/"/>
    
      <category term="workerman" scheme="https://sbcoder.cn/tags/workerman/"/>
    
  </entry>
  
  <entry>
    <title>UnblockNeteaseMusic 解锁网易云音乐灰色歌曲</title>
    <link href="https://sbcoder.cn/2020/05/09/UnblockNeteaseMusic.html"/>
    <id>https://sbcoder.cn/2020/05/09/UnblockNeteaseMusic.html</id>
    <published>2020-05-09T13:52:19.000Z</published>
    <updated>2020-05-09T13:53:34.444Z</updated>
    
    <content type="html"><![CDATA[<h2 id="Docker-安装运行服务端"><a href="#Docker-安装运行服务端" class="headerlink" title="Docker 安装运行服务端"></a>Docker 安装运行服务端</h2><p>基于<a href="https://github.com/nondanee/UnblockNeteaseMusic" target="_blank" rel="noopener">nondanee/UnblockNeteaseMusic</a>的音乐解锁代理服务</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run --name=unblockneteasemusic -d -p 8888:8080 nondanee/unblockneteasemusic</span><br></pre></td></tr></table></figure><p>日志界面 </p><p><img src="https://s1.ax1x.com/2020/05/09/YQcznA.png" alt="Docker内部日志"></p><h2 id="配置客户端"><a href="#配置客户端" class="headerlink" title="配置客户端"></a>配置客户端</h2><table><thead><tr><th style="text-align:left">平台</th><th style="text-align:left">基础设置</th></tr></thead><tbody><tr><td style="text-align:left">Windows</td><td style="text-align:left">设置 &gt; 工具 &gt; 自定义代理 (客户端内)</td></tr><tr><td style="text-align:left">UWP</td><td style="text-align:left">Windows 设置 &gt; 网络和 Internet &gt; 代理</td></tr><tr><td style="text-align:left">Linux</td><td style="text-align:left">系统设置 &gt; 网络 &gt; 网络代理</td></tr><tr><td style="text-align:left">macOS</td><td style="text-align:left">系统偏好设置 &gt; 网络 &gt; 高级 &gt; 代理</td></tr><tr><td style="text-align:left">Android</td><td style="text-align:left">WLAN &gt; 修改网络 &gt; 高级选项 &gt; 代理</td></tr><tr><td style="text-align:left">iOS</td><td style="text-align:left">无线局域网 &gt; HTTP 代理 &gt; 配置代理</td></tr></tbody></table><figure class="image-bubble">                <div class="img-lightbox">                    <div class="overlay"></div>                    <img src="https://s1.ax1x.com/2020/05/09/YQcvXd.png" alt="Windows配置截图" title>                </div>                <div class="image-caption">Windows配置截图</div>            </figure><p>将ip设置为服务器ip即可，映射内部的8080到外部8888端口</p><figure class="image-bubble">                <div class="img-lightbox">                    <div class="overlay"></div>                    <img src="https://s1.ax1x.com/2020/05/09/YQcj6H.png" alt="效果" title>                </div>                <div class="image-caption">效果</div>            </figure><p>当播放或者下载时，日志会记录，解析过程</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;Docker-安装运行服务端&quot;&gt;&lt;a href=&quot;#Docker-安装运行服务端&quot; class=&quot;headerlink&quot; title=&quot;Docker 安装运行服务端&quot;&gt;&lt;/a&gt;Docker 安装运行服务端&lt;/h2&gt;&lt;p&gt;基于&lt;a href=&quot;https://git
      
    
    </summary>
    
      <category term="折腾" scheme="https://sbcoder.cn/categories/%E6%8A%98%E8%85%BE/"/>
    
    
      <category term="Docker" scheme="https://sbcoder.cn/tags/Docker/"/>
    
      <category term="音乐" scheme="https://sbcoder.cn/tags/%E9%9F%B3%E4%B9%90/"/>
    
  </entry>
  
  <entry>
    <title>2020年计划</title>
    <link href="https://sbcoder.cn/2020/02/19/2020.html"/>
    <id>https://sbcoder.cn/2020/02/19/2020.html</id>
    <published>2020-02-19T01:50:52.000Z</published>
    <updated>2020-05-01T01:43:27.538Z</updated>
    
    <content type="html"><![CDATA[<h2 id="开源项目计划"><a href="#开源项目计划" class="headerlink" title="开源项目计划"></a>开源项目计划</h2><h3 id="vFeedBack整合，重构vFeedBack项目，完善系统"><a href="#vFeedBack整合，重构vFeedBack项目，完善系统" class="headerlink" title="vFeedBack整合，重构vFeedBack项目，完善系统"></a>vFeedBack整合，重构vFeedBack项目，完善系统</h3><ul><li>vFeedBack准备列入我的第一个商业系统</li><li>vFeedBack将更适合企业应用</li><li>vFeedBack将区分商业和个人版</li><li>企业可以单独运营vFeedBack项目</li><li>我自己也将独立运营<h3 id="Pollos网址导航暂停"><a href="#Pollos网址导航暂停" class="headerlink" title="Pollos网址导航暂停"></a>Pollos网址导航暂停</h3></li><li>Pollos是一个坑爹的项目</li><li>数据库丢失，继续下去需要很多的人力物力，需要重理思路逻辑</li><li>后台模板可能涉及侵权问题，需要重写<h3 id="写一个通用的后台管理系统"><a href="#写一个通用的后台管理系统" class="headerlink" title="写一个通用的后台管理系统"></a>写一个通用的后台管理系统</h3></li><li>支持前后端分离项目</li><li>预备将Pollos的管理系统修改为这个新的管理系统</li><li>预备要做的很多</li><li>暂定名字为 easyAdmin，基于Laravel5.8以上</li></ul><h2 id="前端知识补充"><a href="#前端知识补充" class="headerlink" title="前端知识补充"></a>前端知识补充</h2><ul><li>学习VUE，刻不容缓 （进行中）</li><li>Element UI学习，前后端分离，VUE</li></ul><h2 id="知识补充"><a href="#知识补充" class="headerlink" title="知识补充"></a>知识补充</h2><ul><li>学习Socket相关知识</li><li>laravel深入了解</li><li>Golang加深</li><li>Docker加深，k8s，Rancher(想去面试)</li></ul><h2 id="某事结束后"><a href="#某事结束后" class="headerlink" title="某事结束后"></a>某事结束后</h2><ul><li><del>争取今年自己还房贷</del></li><li>把xnbox做一做，没准能赚点外快</li><li><del>玩个网游，下班无聊时还能看一看</del> （不执行）</li></ul><h2 id="找个女朋友"><a href="#找个女朋友" class="headerlink" title="找个女朋友"></a>找个女朋友</h2><p>老生常谈，不知道能不能行，我得抓紧了（暂缓执行）</p><h2 id="减肥20斤"><a href="#减肥20斤" class="headerlink" title="减肥20斤"></a>减肥20斤</h2><p>肚子大了，今年目标20斤，干掉肚腩</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;开源项目计划&quot;&gt;&lt;a href=&quot;#开源项目计划&quot; class=&quot;headerlink&quot; title=&quot;开源项目计划&quot;&gt;&lt;/a&gt;开源项目计划&lt;/h2&gt;&lt;h3 id=&quot;vFeedBack整合，重构vFeedBack项目，完善系统&quot;&gt;&lt;a href=&quot;#vFeedBa
      
    
    </summary>
    
      <category term="note" scheme="https://sbcoder.cn/categories/note/"/>
    
    
      <category term="笔记" scheme="https://sbcoder.cn/tags/%E7%AC%94%E8%AE%B0/"/>
    
      <category term="计划" scheme="https://sbcoder.cn/tags/%E8%AE%A1%E5%88%92/"/>
    
  </entry>
  
  <entry>
    <title>Aria2 + Rclone + Goindex 实现离线下载在线观看</title>
    <link href="https://sbcoder.cn/2020/01/22/aria_goindex.html"/>
    <id>https://sbcoder.cn/2020/01/22/aria_goindex.html</id>
    <published>2020-01-21T23:32:33.000Z</published>
    <updated>2020-01-23T00:48:01.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h2><ul><li>云阀 5R NAT小鸡 </li><li>Google Drive 账号一枚</li><li>CloudFlare 账号</li></ul><p><strong><em>关于云阀的小鸡，性价比高，只提供ipv6和ipv4端口，因此下面的教程可能某些地方做了多余的动作，例如修改端口号等</em></strong></p><h2 id="安装Aria2一键脚本"><a href="#安装Aria2一键脚本" class="headerlink" title="安装Aria2一键脚本"></a>安装Aria2一键脚本</h2><p>执行下面的命令<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget -N git.io/aria2.sh &amp;&amp; chmod +x aria2.sh &amp;&amp; ./aria2.sh</span><br></pre></td></tr></table></figure></p><p>进入下载脚本的目录运行脚本<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">./aria2.sh</span><br><span class="line"></span><br><span class="line">Aria2 一键安装管理脚本 [vX.X.X]</span><br><span class="line">-- P3TERX.COM --</span><br><span class="line"></span><br><span class="line">1. 升级脚本</span><br><span class="line">————————————</span><br><span class="line">1. 安装 Aria2</span><br><span class="line">2. 更新 Aria2</span><br><span class="line">3. 卸载 Aria2</span><br><span class="line">————————————</span><br><span class="line">4. 启动 Aria2</span><br><span class="line">5. 停止 Aria2</span><br><span class="line">6. 重启 Aria2</span><br><span class="line">————————————</span><br><span class="line">7. 修改 配置</span><br><span class="line">8. 查看 配置</span><br><span class="line">9. 查看 日志</span><br><span class="line">10. 清空 日志</span><br><span class="line">————————————</span><br><span class="line">11. 手动更新 BT-Tracker</span><br><span class="line">12. 自动更新 BT-Tracker</span><br><span class="line">————————————</span><br><span class="line"></span><br><span class="line">当前状态: 已安装 并 已启动</span><br><span class="line"></span><br><span class="line">请输入数字 [0-12]:</span><br></pre></td></tr></table></figure></p><p>输入 1 回车<br><figure class="image-bubble">                <div class="img-lightbox">                    <div class="overlay"></div>                    <img src="https://s2.ax1x.com/2020/01/20/1PDwZQ.png" alt="1.png" title>                </div>                <div class="image-caption">1.png</div>            </figure><br>等待安装完成 再执行<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./aria2.sh</span><br></pre></td></tr></table></figure></p><p>输入 7 回车<br><figure class="image-bubble">                <div class="img-lightbox">                    <div class="overlay"></div>                    <img src="https://s2.ax1x.com/2020/01/20/1PDBIs.png" alt="2.png" title>                </div>                <div class="image-caption">2.png</div>            </figure></p><p>如需要可修改 RPC 密码，也建议修改</p><h2 id="安装-LNMP-一键安装包-Nginx"><a href="#安装-LNMP-一键安装包-Nginx" class="headerlink" title="安装 LNMP 一键安装包 / Nginx"></a>安装 LNMP 一键安装包 / Nginx</h2><p>我这里安装LNMP，其实只需要 Nginx就行了<br>安装教程参考 <a href="https://lnmp.org/install.html" target="_blank" rel="noopener">安装 - LNMP一键安装包</a></p><p>或者 直接执行<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget http://soft.vpser.net/lnmp/lnmp1.6.tar.gz -cO lnmp1.6.tar.gz &amp;&amp; tar zxf lnmp1.6.tar.gz &amp;&amp; cd lnmp1.6 &amp;&amp; ./install.sh lnmp</span><br></pre></td></tr></table></figure></p><p>我这里安装的是 1.6 ，可自行修改版本号</p><h2 id="安装-Aria2NG-界面管理"><a href="#安装-Aria2NG-界面管理" class="headerlink" title="安装 Aria2NG 界面管理"></a>安装 Aria2NG 界面管理</h2><p>打开地址 <a href="https://github.com/mayswind/AriaNg/releases" target="_blank" rel="noopener">Releases · mayswind/AriaNg</a><br>选择最新版本下载到 网站 目录下，如果不知道网站目录配置，建议存放在 LNMP的默认目录 /home/wwwroot/</p><p>按照如下操作<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mkdir /home/wwwroot/X</span><br><span class="line">cd /home/wwwroot/X</span><br><span class="line">wget https://github.com/mayswind/AriaNg/releases/download/1.1.4/AriaNg-1.1.4.zip</span><br><span class="line">unzip AriaNg-1.1.4.zip</span><br><span class="line">rm AriaNg-1.1.4.zip</span><br></pre></td></tr></table></figure></p><p>配置 Nginx<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd /usr/local/nginx/conf/vhost/</span><br><span class="line">vi X.conf</span><br></pre></td></tr></table></figure></p><p>输入以下配置<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">server</span><br><span class="line">    &#123;</span><br><span class="line">        listen 10002 default_server reuseport;</span><br><span class="line">        #listen [::]:80 default_server ipv6only=on;</span><br><span class="line">        server_name _;</span><br><span class="line">        index index.html index.htm index.php;</span><br><span class="line">        root  /home/wwwroot/x;</span><br><span class="line"></span><br><span class="line">        #error_page   404   /404.html;</span><br><span class="line"></span><br><span class="line">        # Deny access to PHP files in specific directory</span><br><span class="line">        #location ~ /(wp-content|uploads|wp-includes|images)/.*\.php$ &#123; deny all; &#125;</span><br><span class="line"></span><br><span class="line">        include enable-php.conf;</span><br><span class="line"></span><br><span class="line">        location /nginx_status</span><br><span class="line">        &#123;</span><br><span class="line">            stub_status on;</span><br><span class="line">            access_log   off;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        location ~ .*\.(gif|jpg|jpeg|png|bmp|swf)$</span><br><span class="line">        &#123;</span><br><span class="line">            expires      30d;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        location ~ .*\.(js|css)?$</span><br><span class="line">        &#123;</span><br><span class="line">            expires      12h;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        location ~ /.well-known &#123;</span><br><span class="line">            allow all;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        location ~ /\.</span><br><span class="line">        &#123;</span><br><span class="line">            deny all;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        access_log  /home/wwwlogs/access.log;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p><p>主要就是把端口改为 10002，其他的就是lnmp默认配置不动</p><p>配置完毕后，打开 网址 <a href="http://virt-nat-eu-1.cloudraft.cn:1XXX5" target="_blank" rel="noopener">http://virt-nat-eu-1.cloudraft.cn:1XXX5</a><br>将XX替换成你的 内网IP最后一位 例如 2 则访问 <a href="http://virt-nat-eu-1.cloudraft.cn:10025" target="_blank" rel="noopener">http://virt-nat-eu-1.cloudraft.cn:10025</a></p><figure class="image-bubble">                <div class="img-lightbox">                    <div class="overlay"></div>                    <img src="https://s2.ax1x.com/2020/01/20/1PyZ2q.png" alt="3.png" title>                </div>                <div class="image-caption">3.png</div>            </figure><p>点击 Aria2NG配置 - RPC(XXXX)</p><figure class="image-bubble">                <div class="img-lightbox">                    <div class="overlay"></div>                    <img src="https://s2.ax1x.com/2020/01/20/1Py7zq.png" alt="4.png" title>                </div>                <div class="image-caption">4.png</div>            </figure><p>修改 RPC 别名 RPC 地址 RPC 秘钥<br>其他不动，按图填写即可</p><h2 id="免费申请一个Google无限团队盘"><a href="#免费申请一个Google无限团队盘" class="headerlink" title="免费申请一个Google无限团队盘"></a>免费申请一个Google无限团队盘</h2><p>打开地址 <a href="https://tv.ssr.workers.dev/" target="_blank" rel="noopener">创建Google TeamDrive</a><br>Gmail必须填写正确！</p><p>等待创建即可！</p><h2 id="安装Rclone"><a href="#安装Rclone" class="headerlink" title="安装Rclone"></a>安装Rclone</h2><p>执行<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">curl https://rclone.org/install.sh | sudo bash</span><br><span class="line">rclone config</span><br></pre></td></tr></table></figure></p><p>配置说明如下<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br></pre></td><td class="code"><pre><span class="line">e) Edit existing remote</span><br><span class="line">n) New remote</span><br><span class="line">d) Delete remote</span><br><span class="line">r) Rename remote</span><br><span class="line">c) Copy remote</span><br><span class="line">s) Set configuration password</span><br><span class="line">q) Quit config</span><br><span class="line">e/n/d/r/c/s/q&gt; n  # 选择n，新建</span><br><span class="line">name&gt; Google  # 输入名称，类似于标签，用于区分不同的网盘。</span><br><span class="line">Type of storage to configure.</span><br><span class="line">Enter a string value. Press Enter for the default (&quot;&quot;).</span><br><span class="line">Choose a number from below, or type in your own value</span><br><span class="line"> 1 / A stackable unification remote, which can appear to merge the contents of several remotes</span><br><span class="line">   \ &quot;union&quot;</span><br><span class="line"> 2 / Alias for a existing remote</span><br><span class="line">   \ &quot;alias&quot;</span><br><span class="line"> 3 / Amazon Drive</span><br><span class="line">   \ &quot;amazon cloud drive&quot;</span><br><span class="line"> 4 / Amazon S3 Compliant Storage Providers (AWS, Ceph, Dreamhost, IBM COS, Minio)</span><br><span class="line">   \ &quot;s3&quot;</span><br><span class="line"> 5 / Backblaze B2</span><br><span class="line">   \ &quot;b2&quot;</span><br><span class="line"> 6 / Box</span><br><span class="line">   \ &quot;box&quot;</span><br><span class="line"> 7 / Cache a remote</span><br><span class="line">   \ &quot;cache&quot;</span><br><span class="line"> 8 / Dropbox</span><br><span class="line">   \ &quot;dropbox&quot;</span><br><span class="line"> 9 / Encrypt/Decrypt a remote</span><br><span class="line">   \ &quot;crypt&quot;</span><br><span class="line">10 / FTP Connection</span><br><span class="line">   \ &quot;ftp&quot;</span><br><span class="line">11 / Google Cloud Storage (this is not Google Drive)</span><br><span class="line">   \ &quot;google cloud storage&quot;</span><br><span class="line">12 / Google Drive</span><br><span class="line">   \ &quot;drive&quot;</span><br><span class="line">13 / Hubic</span><br><span class="line">   \ &quot;hubic&quot;</span><br><span class="line">14 / JottaCloud</span><br><span class="line">   \ &quot;jottacloud&quot;</span><br><span class="line">15 / Local Disk</span><br><span class="line">   \ &quot;local&quot;</span><br><span class="line">16 / Mega</span><br><span class="line">   \ &quot;mega&quot;</span><br><span class="line">17 / Microsoft Azure Blob Storage</span><br><span class="line">   \ &quot;azureblob&quot;</span><br><span class="line">18 / Microsoft OneDrive</span><br><span class="line">   \ &quot;onedrive&quot;</span><br><span class="line">19 / OpenDrive</span><br><span class="line">   \ &quot;opendrive&quot;</span><br><span class="line">20 / Openstack Swift (Rackspace Cloud Files, Memset Memstore, OVH)</span><br><span class="line">   \ &quot;swift&quot;</span><br><span class="line">21 / Pcloud</span><br><span class="line">   \ &quot;pcloud&quot;</span><br><span class="line">22 / QingCloud Object Storage</span><br><span class="line">   \ &quot;qingstor&quot;</span><br><span class="line">23 / SSH/SFTP Connection</span><br><span class="line">   \ &quot;sftp&quot;</span><br><span class="line">24 / Webdav</span><br><span class="line">   \ &quot;webdav&quot;</span><br><span class="line">25 / Yandex Disk</span><br><span class="line">   \ &quot;yandex&quot;</span><br><span class="line">26 / http Connection</span><br><span class="line">   \ &quot;http&quot;</span><br><span class="line">Storage&gt; 12  # 选择12，Google Drive</span><br><span class="line">** See help for drive backend at: https://rclone.org/drive/ **</span><br><span class="line"></span><br><span class="line">Google Application Client Id</span><br><span class="line">Leave blank normally.</span><br><span class="line">Enter a string value. Press Enter for the default (&quot;&quot;).</span><br><span class="line">client_id&gt;  # 留空，回车</span><br><span class="line">Google Application Client Secret</span><br><span class="line">Leave blank normally.</span><br><span class="line">Enter a string value. Press Enter for the default (&quot;&quot;).</span><br><span class="line">client_secret&gt;  # 留空，回车</span><br><span class="line">Scope that rclone should use when requesting access from drive.</span><br><span class="line">Enter a string value. Press Enter for the default (&quot;&quot;).</span><br><span class="line">Choose a number from below, or type in your own value</span><br><span class="line"> 1 / Full access all files, excluding Application Data Folder.</span><br><span class="line">   \ &quot;drive&quot;</span><br><span class="line"> 2 / Read-only access to file metadata and file contents.</span><br><span class="line">   \ &quot;drive.readonly&quot;</span><br><span class="line">   / Access to files created by rclone only.</span><br><span class="line"> 3 | These are visible in the drive website.</span><br><span class="line">   | File authorization is revoked when the user deauthorizes the app.</span><br><span class="line">   \ &quot;drive.file&quot;</span><br><span class="line">   / Allows read and write access to the Application Data folder.</span><br><span class="line"> 4 | This is not visible in the drive website.</span><br><span class="line">   \ &quot;drive.appfolder&quot;</span><br><span class="line">   / Allows read-only access to file metadata but</span><br><span class="line"> 5 | does not allow any access to read or download file content.</span><br><span class="line">   \ &quot;drive.metadata.readonly&quot;</span><br><span class="line">scope&gt; 1</span><br><span class="line">ID of the root folder</span><br><span class="line">Leave blank normally.</span><br><span class="line">Fill in to access &quot;Computers&quot; folders. (see docs).</span><br><span class="line">Enter a string value. Press Enter for the default (&quot;&quot;).</span><br><span class="line">root_folder_id&gt;  # 留空，回车</span><br><span class="line">Service Account Credentials JSON file path</span><br><span class="line">Leave blank normally.</span><br><span class="line">Needed only if you want use SA instead of interactive login.</span><br><span class="line">Enter a string value. Press Enter for the default (&quot;&quot;).</span><br><span class="line">service_account_file&gt;</span><br><span class="line">Edit advanced config? (y/n)</span><br><span class="line">y) Yes</span><br><span class="line">n) No</span><br><span class="line">y/n&gt; n</span><br><span class="line">Remote config</span><br><span class="line">Use auto config?</span><br><span class="line"> * Say Y if not sure</span><br><span class="line"> * Say N if you are working on a remote or headless machine or Y didn&apos;t work</span><br><span class="line">y) Yes</span><br><span class="line">n) No</span><br><span class="line">y/n&gt; n</span><br><span class="line">If your browser doesn&apos;t open automatically go to the following link: https://accounts.google.com/o/oauth2/auth?access_type=offline&amp;client_id=XXXXXXXXXXX.apps.googleusercontent.com&amp;redirect_uri=urn%3Aietf%3Awg%3Aoauth%3A2.0%3Aoob&amp;response_type=code&amp;scope=https%3A%2F%2Fwww.googleapis.com%2Fauth%2Fdrive&amp;state=XXXXXXXXXXXXXXXXXXXX</span><br><span class="line">Log in and authorize rclone for access  # 会弹出浏览器，要求你登录账号进行授权。如果没有弹出，复制上面的链接到浏览器中打开进行授权。</span><br><span class="line">Enter verification code&gt;  # 在这里输入网页上显示的验证码</span><br><span class="line"></span><br><span class="line">Configure this as a team drive?</span><br><span class="line">y) Yes</span><br><span class="line">n) No</span><br><span class="line">y/n&gt; y</span><br><span class="line">Fetching team drive list...</span><br><span class="line">No team drives found in your account--------------------</span><br><span class="line">[Google]</span><br><span class="line">type = drive</span><br><span class="line">scope = drive</span><br><span class="line">token = &#123;&quot;access_token&quot;:&quot;XXXXXXXXXXXXXXXXXXXXX&quot;&#125;</span><br><span class="line">--------------------</span><br><span class="line">y) Yes this is OK</span><br><span class="line">e) Edit this remote</span><br><span class="line">d) Delete this remote</span><br><span class="line">y/e/d&gt; y</span><br><span class="line">Current remotes:</span><br><span class="line"></span><br><span class="line">Name                 Type</span><br><span class="line">====                 ====</span><br><span class="line">Google               drive</span><br><span class="line">One                  onedrive</span><br><span class="line"></span><br><span class="line">e) Edit existing remote</span><br><span class="line">n) New remote</span><br><span class="line">d) Delete remote</span><br><span class="line">r) Rename remote</span><br><span class="line">c) Copy remote</span><br><span class="line">s) Set configuration password</span><br><span class="line">q) Quit config</span><br><span class="line">e/n/d/r/c/s/q&gt; q</span><br></pre></td></tr></table></figure></p><p>参考:<a href="https://p3terx.com/archives/rclone-installation-and-configuration-tutorial.html" target="_blank" rel="noopener">P3TERX - Rclone 安装配置教程 - 连接 OneDrive 和 Google Drive</a></p><h2 id="配置-Aira2-自动上传"><a href="#配置-Aira2-自动上传" class="headerlink" title="配置 Aira2 自动上传"></a>配置 Aira2 自动上传</h2><p>执行 按图修改<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vi /root/.aria2/autoupload.sh</span><br></pre></td></tr></table></figure></p><figure class="image-bubble">                <div class="img-lightbox">                    <div class="overlay"></div>                    <img src="https://s2.ax1x.com/2020/01/20/1Pczx1.png" alt="5.png" title>                </div>                <div class="image-caption">5.png</div>            </figure><p>执行 按图修改<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vi /root/.aria2/aria2.conf</span><br></pre></td></tr></table></figure></p><figure class="image-bubble">                <div class="img-lightbox">                    <div class="overlay"></div>                    <img src="https://s2.ax1x.com/2020/01/20/1PgbQI.png" alt="6.png" title>                </div>                <div class="image-caption">6.png</div>            </figure><p>重启 Aria2<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">service aria2 restart</span><br></pre></td></tr></table></figure></p><h2 id="使用Goindex-CloudFlare搞一个在线观看"><a href="#使用Goindex-CloudFlare搞一个在线观看" class="headerlink" title="使用Goindex + CloudFlare搞一个在线观看"></a>使用Goindex + CloudFlare搞一个在线观看</h2><p>官方说明 <a href="https://github.com/donwa/goindex" target="_blank" rel="noopener">donwa/Github</a></p><p>复制 <a href="https://github.com/donwa/goindex/blob/master/index.js" target="_blank" rel="noopener">index.js</a> 里面的代码</p><p>打开 CloudFlare ，创建Workers</p><figure class="image-bubble">                <div class="img-lightbox">                    <div class="overlay"></div>                    <img src="https://s2.ax1x.com/2020/01/20/1PLmSP.png" alt="7.png" title>                </div>                <div class="image-caption">7.png</div>            </figure><p>将上面复制的内容黏贴到Script中</p><p>执行 并 查看 rclone.conf 路径。<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rclone config file</span><br></pre></td></tr></table></figure></p><figure class="image-bubble">                <div class="img-lightbox">                    <div class="overlay"></div>                    <img src="https://s2.ax1x.com/2020/01/20/1Pq5R0.png" alt="8.png" title>                </div>                <div class="image-caption">8.png</div>            </figure><p>复制 root_folder_id 和 refresh_token 的值填入 CloudFlare Workers Script对应的代码位置里面<br><figure class="image-bubble">                <div class="img-lightbox">                    <div class="overlay"></div>                    <img src="https://s2.ax1x.com/2020/01/20/1PLotA.png" alt="9.png" title>                </div>                <div class="image-caption">9.png</div>            </figure></p><p>配置好后点击保存，然后打开CloudFlare Workers提供的域名即可看到对应的网盘内容</p><p>作者博客 <a href="https://sbcoder.cn">风向标博客</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;准备工作&quot;&gt;&lt;a href=&quot;#准备工作&quot; class=&quot;headerlink&quot; title=&quot;准备工作&quot;&gt;&lt;/a&gt;准备工作&lt;/h2&gt;&lt;ul&gt;
&lt;li&gt;云阀 5R NAT小鸡 &lt;/li&gt;
&lt;li&gt;Google Drive 账号一枚&lt;/li&gt;
&lt;li&gt;CloudFl
      
    
    </summary>
    
      <category term="折腾" scheme="https://sbcoder.cn/categories/%E6%8A%98%E8%85%BE/"/>
    
    
      <category term="离线下载" scheme="https://sbcoder.cn/tags/%E7%A6%BB%E7%BA%BF%E4%B8%8B%E8%BD%BD/"/>
    
      <category term="Google" scheme="https://sbcoder.cn/tags/Google/"/>
    
  </entry>
  
  <entry>
    <title>Canal 根据 binlog日志数据同步</title>
    <link href="https://sbcoder.cn/2020/01/22/canal_go.html"/>
    <id>https://sbcoder.cn/2020/01/22/canal_go.html</id>
    <published>2020-01-21T23:32:09.000Z</published>
    <updated>2020-01-21T23:33:46.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="创建mysql账户"><a href="#创建mysql账户" class="headerlink" title="创建mysql账户"></a>创建mysql账户</h2><p>如果使用的是root用户，则不需要操作这个步骤</p><p>grant all privileges on  <em>.</em> to  ‘jcc’@’%’ identified by ‘jcc’;<br>flush privileges;</p><h2 id="配置mysql-参见canal-Quickstart"><a href="#配置mysql-参见canal-Quickstart" class="headerlink" title="配置mysql (参见canal　Quickstart)"></a>配置mysql (参见canal　Quickstart)</h2><p>启用binlog日志<br>打开 mysql.cnf 文件<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[mysqld] </span><br><span class="line">log-bin=mysql-bin </span><br><span class="line">binlog-format=ROW #选择row模式 </span><br><span class="line">server_id=9527 #配置mysql replaction需要定义，不能和canal的slaveId重复</span><br></pre></td></tr></table></figure></p><h2 id="添加slave权限"><a href="#添加slave权限" class="headerlink" title="添加slave权限"></a>添加slave权限</h2><p>如果使用的是root用户，则不需要操作这个步骤<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">USER</span> canal <span class="keyword">IDENTIFIED</span> <span class="keyword">BY</span> <span class="string">'canal'</span>;  </span><br><span class="line"><span class="keyword">GRANT</span> <span class="keyword">SELECT</span>, <span class="keyword">SHOW</span> <span class="keyword">VIEW</span>, <span class="keyword">REPLICATION</span> <span class="keyword">SLAVE</span>, <span class="keyword">REPLICATION</span> <span class="keyword">CLIENT</span> <span class="keyword">ON</span> *.* <span class="keyword">TO</span> <span class="string">'canal'</span>@<span class="string">'%'</span>;<span class="keyword">FLUSH</span> <span class="keyword">PRIVILEGES</span>;</span><br></pre></td></tr></table></figure></p><h2 id="创建canal-server-服务端"><a href="#创建canal-server-服务端" class="headerlink" title="创建canal server 服务端"></a>创建canal server 服务端</h2><p>需要提前安装好Docker，如果不会安装，可以参考我之前写的文章 <a href="https://sbcoder.cn/2019/12/10/gogs_docker.html#CentOS7-%E5%AE%89%E8%A3%85-Docker">CentOS7 安装 Docker</a></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -p 11111:11111 -e canal.auto.scan=false -e canal.instance.master.address=127.0.0.1:3306 -e canal.instance.dbUsername=test -e canal.instance.dbPassword=test -e canal.instance.connectionCharset=UTF-8 -e canal.instance.tsdb.enable=true -e canal.instance.gtidon=false -e canal.instance.filter.regex=.*\\..* -e canal.destinations=test  -d canal/canal-server</span><br></pre></td></tr></table></figure><p>需要替换以下参数</p><ul><li>canal.instance.master.address=127.0.0.1:3306  地址ip更换（尽量用内网）  </li><li>canal.instance.dbUsername=test     数据库账户  </li><li>canal.instance.dbPassword=test      数据库密码</li><li>canal.destinations=test          test为名称 可以修改</li><li>11111:11111       服务器端口：docker端口</li></ul><p>需要注意的是，所填写的数据库账户必须拥有数据库的操作权限，如果不知道权限如何配置，则建议直接使用root用户</p><h2 id="canal-客户端"><a href="#canal-客户端" class="headerlink" title="canal 客户端"></a>canal 客户端</h2><p>我们这里使用Go客户端，因为Go语言的特性，可以很好的运行在Docker上</p><p>canal-go 文档: <a href="https://github.com/withlin/canal-go" target="_blank" rel="noopener">withlin/canal-go</a></p><p>开发过程可以参照文档</p><h2 id="Docker启动canal客户端"><a href="#Docker启动canal客户端" class="headerlink" title="Docker启动canal客户端"></a>Docker启动canal客户端</h2><p>推荐使用Jenkins配置 canal-go<br>构建成功后执行shell</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker build -t canal_prod:v1 $&#123;WORKSPACE&#125;</span><br><span class="line">docker service update --image canal_prod:v1 --force --no-resolve-image canal_prod</span><br></pre></td></tr></table></figure><p>如果看过我之前的 代码架构文章，可以在Portainer中看到打印在控制台的文字，也可以看到运行状态</p><h2 id="FAQ问题解决"><a href="#FAQ问题解决" class="headerlink" title="FAQ问题解决"></a>FAQ问题解决</h2><p>Q:如果服务停止了，如何解决<br>A:链接到canal-server的Docker内部，查看 canal-server - logs 中的日志</p><p>Q:如果数据同步失败了如何解决<br>A:很大可能是由于改变了数据库结构导致的，需要重启客户端和服务端尝试</p><p>Q:一开始数据就不同步<br>A:查看你的数据库账户是否有权限，如无权限则修改服务端启动时附带的数据库账户参数</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;创建mysql账户&quot;&gt;&lt;a href=&quot;#创建mysql账户&quot; class=&quot;headerlink&quot; title=&quot;创建mysql账户&quot;&gt;&lt;/a&gt;创建mysql账户&lt;/h2&gt;&lt;p&gt;如果使用的是root用户，则不需要操作这个步骤&lt;/p&gt;
&lt;p&gt;grant all p
      
    
    </summary>
    
      <category term="优化" scheme="https://sbcoder.cn/categories/%E4%BC%98%E5%8C%96/"/>
    
    
      <category term="数据库" scheme="https://sbcoder.cn/tags/%E6%95%B0%E6%8D%AE%E5%BA%93/"/>
    
      <category term="优化" scheme="https://sbcoder.cn/tags/%E4%BC%98%E5%8C%96/"/>
    
  </entry>
  
  <entry>
    <title>ThinkPHP使用RabbitMQ进行数据解耦 从安装到监听完全版</title>
    <link href="https://sbcoder.cn/2020/01/07/rabbitmq_thinkphp.html"/>
    <id>https://sbcoder.cn/2020/01/07/rabbitmq_thinkphp.html</id>
    <published>2020-01-07T15:32:40.000Z</published>
    <updated>2020-01-07T15:33:42.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h2><p>分布式部署，RabbitMQ(简称MQ)作为消息中间件是一个非常不错的选择，可以实现异步互不干扰的解耦操作。</p><h2 id="解决需求"><a href="#解决需求" class="headerlink" title="解决需求"></a>解决需求</h2><p>当有两套系统分别部署时，需要同步一部分数据，或者需要互不干扰解决异步独立运行时，可以使用RebbitMQ来给两套系统解耦，使用RebbitMQ作为中间件，只做消息传输使用，当系统A宕机或者因故障无法使用时，不会影响到系统B的正常运行！</p><h2 id="部署MQ"><a href="#部署MQ" class="headerlink" title="部署MQ"></a>部署MQ</h2><p>使用Docker部署，安装Docker可以参照之前写的 <a href="https://sbcoder.cn/2019/12/10/gogs_docker.html#CentOS7-%E5%AE%89%E8%A3%85-Docker">CentOS7 安装 Docker</a>，或者<a href="https://sbcoder.cn/2019/12/09/code_build.html#Ubuntu16-04-Ubuntu18-04-%E5%AE%89%E8%A3%85-Docker">Ubuntu16.04/Ubuntu18.04 安装 Docker</a>。</p><p>下载镜像<br>镜像地址 <a href="https://registry.hub.docker.com/_/rabbitmq/" target="_blank" rel="noopener">rabbitmq</a><br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker pull rabbitmq:management</span><br></pre></td></tr></table></figure></p><figure class="image-bubble">                <div class="img-lightbox">                    <div class="overlay"></div>                    <img src="https://i.loli.net/2019/12/14/T9r4zdpChFlJ85A.png" alt="1.png" title>                </div>                <div class="image-caption">1.png</div>            </figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># 创建容器并运行</span><br><span class="line">docker run -d -p 5672:5672 -p 15672:15672 --name rabbitmq rabbitmq:management</span><br><span class="line"># 查看 当前运行的容器</span><br><span class="line">docker ps</span><br></pre></td></tr></table></figure><figure class="image-bubble">                <div class="img-lightbox">                    <div class="overlay"></div>                    <img src="https://i.loli.net/2019/12/14/vyqx8KmEa2RWSD5.png" alt="2.png" title>                </div>                <div class="image-caption">2.png</div>            </figure><h2 id="配置MQ"><a href="#配置MQ" class="headerlink" title="配置MQ"></a>配置MQ</h2><h3 id="安装MQ"><a href="#安装MQ" class="headerlink" title="安装MQ"></a>安装MQ</h3><p>打开 <a href="http://localhost:15672" target="_blank" rel="noopener">http://IP:15672</a><br><figure class="image-bubble">                <div class="img-lightbox">                    <div class="overlay"></div>                    <img src="https://i.loli.net/2019/12/14/W1BTxs8krceSZqV.png" alt="3.png" title>                </div>                <div class="image-caption">3.png</div>            </figure><br>使用默认用户名密码登录<br>username:guest password:guest<br><figure class="image-bubble">                <div class="img-lightbox">                    <div class="overlay"></div>                    <img src="https://i.loli.net/2019/12/14/fDuaX6cMbiSpFI5.png" alt="4.png" title>                </div>                <div class="image-caption">4.png</div>            </figure><br>红框内为你的rabbitmq版本号，我这里是3.8.2</p><p>创建一个管理员用户<br><figure class="image-bubble">                <div class="img-lightbox">                    <div class="overlay"></div>                    <img src="https://i.loli.net/2019/12/14/LUnvRskT2ocyHh6.png" alt="5.png" title>                </div>                <div class="image-caption">5.png</div>            </figure></p><p>修改guest的密码，请将123456修改为你需要修改的密码<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker exec -it rabbitmq /bin/bash</span><br><span class="line">rabbitmqctl  list_users</span><br><span class="line">rabbitmqctl  change_password  guest  &apos;123456&apos;</span><br></pre></td></tr></table></figure></p><p>修改guest默认密码以防止被人恶意利用<br><figure class="image-bubble">                <div class="img-lightbox">                    <div class="overlay"></div>                    <img src="https://i.loli.net/2019/12/14/EL7dul54znYxeGA.png" alt="6.png" title>                </div>                <div class="image-caption">6.png</div>            </figure></p><h3 id="创建队列及交换机"><a href="#创建队列及交换机" class="headerlink" title="创建队列及交换机"></a>创建队列及交换机</h3><p>创建队列可以在mq页端创建也可以在代码中自动创建，我这里直接在页端创建<br><figure class="image-bubble">                <div class="img-lightbox">                    <div class="overlay"></div>                    <img src="https://s2.ax1x.com/2020/01/07/l6CsBV.png" alt="创建Queen" title>                </div>                <div class="image-caption">创建Queen</div>            </figure></p><p>创建交换机，也在页端创建好<br><figure class="image-bubble">                <div class="img-lightbox">                    <div class="overlay"></div>                    <img src="https://s2.ax1x.com/2020/01/07/l6CBXq.png" alt="创建Exchange" title>                </div>                <div class="image-caption">创建Exchange</div>            </figure></p><h2 id="ThinkPHP实现过程"><a href="#ThinkPHP实现过程" class="headerlink" title="ThinkPHP实现过程"></a>ThinkPHP实现过程</h2><h3 id="Composer安装php-amqplib"><a href="#Composer安装php-amqplib" class="headerlink" title="Composer安装php-amqplib"></a>Composer安装php-amqplib</h3><p>略</p><h3 id="生产者实现"><a href="#生产者实现" class="headerlink" title="生产者实现"></a>生产者实现</h3><ul><li>创建一个生产者类放置于 common 目录下，方便调用</li></ul><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RabbitMq</span></span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> $connection;</span><br><span class="line">    <span class="keyword">protected</span> $channel;</span><br><span class="line">    <span class="comment">//protected $exchange = 'router';  //</span></span><br><span class="line">    <span class="comment">//protected $queue = 'msgs';</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;connection = <span class="keyword">new</span> AMQPStreamConnection(config(<span class="string">'rabbit_mq.host'</span>), config(<span class="string">'rabbit_mq.port'</span>), config(<span class="string">'rabbit_mq.user'</span>), config(<span class="string">'rabbit_mq.password'</span>));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">$this</span>-&gt;channel = <span class="keyword">$this</span>-&gt;connection-&gt;channel();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * 向队列发送信息（生产者）</span></span><br><span class="line"><span class="comment">     * $data 向队列发送参数</span></span><br><span class="line"><span class="comment">     * $code   路由名</span></span><br><span class="line"><span class="comment">     * $queue  主题</span></span><br><span class="line"><span class="comment">     * */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">send</span><span class="params">($data,$exchange,$routing_key=<span class="string">'order'</span>)</span></span>&#123;</span><br><span class="line"><span class="comment">//        $this-&gt;channel-&gt;queue_declare($this-&gt;queue, false, true, false, false);</span></span><br><span class="line"><span class="comment">//        $this-&gt;channel-&gt;exchange_declare($this-&gt;exchange, AMQPExchangeType::DIRECT, false, true, false);</span></span><br><span class="line"><span class="comment">//        $this-&gt;channel-&gt;queue_bind($this-&gt;queue, $this-&gt;exchange);</span></span><br><span class="line"></span><br><span class="line">        $messageBody = json_encode($data);<span class="comment">//将要发送数据变为json字符串</span></span><br><span class="line"></span><br><span class="line">        $message = <span class="keyword">new</span> AMQPMessage($messageBody, <span class="keyword">array</span>(<span class="string">'content_type'</span> =&gt; <span class="string">'text/plain'</span>, <span class="string">'delivery_mode'</span> =&gt; AMQPMessage::DELIVERY_MODE_PERSISTENT));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">$this</span>-&gt;channel-&gt;basic_publish($message,$exchange,$routing_key);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">$this</span>-&gt;stop();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//关闭进程</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">stop</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;channel-&gt;close();</span><br><span class="line">        <span class="keyword">$this</span>-&gt;connection-&gt;close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>实现过程如下</li></ul><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RabbitMq</span> <span class="keyword">extends</span> <span class="title">controller</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> $rabbitMq;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Unit constructor.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> Request $request</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> \think\db\exception\DataNotFoundException</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> \think\db\exception\ModelNotFoundException</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> \think\exception\DbException</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(Request $request)</span></span>&#123;</span><br><span class="line">        <span class="keyword">parent</span>::__construct();</span><br><span class="line">        <span class="keyword">$this</span>-&gt;rabbitMq                = <span class="keyword">new</span> \app\common\RabbitMq();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 添加</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> \think\db\exception\DataNotFoundException</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> \think\db\exception\ModelNotFoundException</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> \think\exception\DbException</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">add</span><span class="params">()</span></span>&#123;</span><br><span class="line">        $params = <span class="keyword">$this</span>-&gt;request-&gt;param();</span><br><span class="line">        <span class="keyword">$this</span>-&gt;rabbitMq-&gt;send($params,<span class="string">'testMq'</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="消费者实现"><a href="#消费者实现" class="headerlink" title="消费者实现"></a>消费者实现</h3><ul><li><p>创建一个RabbitMq类,方便之后调用</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RabbitMq</span> <span class="keyword">extends</span> <span class="title">controller</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> $connection;</span><br><span class="line">    <span class="keyword">protected</span> $channel;</span><br><span class="line">    <span class="keyword">protected</span> $exchange;  <span class="comment">//</span></span><br><span class="line">    <span class="keyword">protected</span> $queue;</span><br><span class="line">    <span class="keyword">protected</span> $vhost;</span><br><span class="line">    <span class="keyword">protected</span> $consumerTag;</span><br><span class="line">    <span class="keyword">protected</span> $routeKey;</span><br><span class="line">    <span class="comment">// 此处使用配置文件配置，具体可自行配置</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">//连接RabbitMQ</span></span><br><span class="line">        <span class="keyword">$this</span>-&gt;queue       = Config::get(<span class="string">'database.RabbitMQ'</span>)[<span class="string">'queue'</span>];</span><br><span class="line">        <span class="keyword">$this</span>-&gt;exchange    = Config::get(<span class="string">'database.RabbitMQ'</span>)[<span class="string">'exchange'</span>];</span><br><span class="line">        <span class="keyword">$this</span>-&gt;vhost       = Config::get(<span class="string">'database.RabbitMQ'</span>)[<span class="string">'vhost'</span>];</span><br><span class="line">        <span class="keyword">$this</span>-&gt;consumerTag = <span class="string">'AgentOrder'</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;routeKey    = <span class="string">'addOrderAndSub'</span>;</span><br><span class="line"></span><br><span class="line">        $host             = Config::get(<span class="string">'database.RabbitMQ'</span>)[<span class="string">'host'</span>];</span><br><span class="line">        $port             = Config::get(<span class="string">'database.RabbitMQ'</span>)[<span class="string">'port'</span>];</span><br><span class="line">        $username         = Config::get(<span class="string">'database.RabbitMQ'</span>)[<span class="string">'username'</span>];</span><br><span class="line">        $password         = Config::get(<span class="string">'database.RabbitMQ'</span>)[<span class="string">'password'</span>];</span><br><span class="line">        <span class="keyword">$this</span>-&gt;connection = <span class="keyword">new</span> AMQPStreamConnection($host, $port, $username, $password);</span><br><span class="line">        <span class="keyword">$this</span>-&gt;channel    = <span class="keyword">$this</span>-&gt;connection-&gt;channel();</span><br><span class="line">        <span class="keyword">$this</span>-&gt;logMqWright(<span class="string">'MQ已连接'</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 消费信息</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getMessage</span><span class="params">($callback)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 队列声明，创建队列，如果不存在则自动创建，如已创建则不需要使用</span></span><br><span class="line">        <span class="comment">// $this-&gt;channel-&gt;queue_declare($this-&gt;queue, false, true, false, false);</span></span><br><span class="line">        <span class="comment">// 绑定交换机</span></span><br><span class="line">        <span class="keyword">$this</span>-&gt;channel-&gt;exchange_declare(<span class="keyword">$this</span>-&gt;exchange, <span class="string">'direct'</span>, <span class="keyword">false</span>, <span class="keyword">true</span>, <span class="keyword">false</span>);</span><br><span class="line">        <span class="keyword">$this</span>-&gt;logMqWright(<span class="string">'---MQ交换机绑定完成---'</span>);</span><br><span class="line">        <span class="comment">// 绑定队列</span></span><br><span class="line">        <span class="keyword">$this</span>-&gt;channel-&gt;queue_bind(<span class="keyword">$this</span>-&gt;queue, <span class="keyword">$this</span>-&gt;exchange, <span class="keyword">$this</span>-&gt;routeKey);</span><br><span class="line">        <span class="keyword">$this</span>-&gt;logMqWright(<span class="string">'---MQ队列绑定完成---'</span>);</span><br><span class="line">        <span class="comment">// 信息消费，no_ack 为true时为自动应答</span></span><br><span class="line">        <span class="keyword">$this</span>-&gt;channel-&gt;basic_consume(<span class="keyword">$this</span>-&gt;queue, <span class="keyword">$this</span>-&gt;consumerTag, <span class="keyword">false</span>, <span class="keyword">true</span>, <span class="keyword">false</span>, <span class="keyword">false</span>, $callback);</span><br><span class="line">        $i = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">while</span> (count(<span class="keyword">$this</span>-&gt;channel-&gt;callbacks)) &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;logMqWright(<span class="string">'---MQ执行次数统计['</span> . $i . <span class="string">']---'</span>);</span><br><span class="line">            $i++;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;channel-&gt;wait();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 日志写入函数 目录/runtime/agent_log/当前年月/当前日期MQ.txt</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">logMqWright</span><span class="params">($msg)</span> </span>&#123;</span><br><span class="line">        $val             = <span class="string">""</span>;</span><br><span class="line">        $currentDateTime = date(<span class="string">'Y-m-d H:i:s'</span>, time());</span><br><span class="line">        $currentDate     = date(<span class="string">'Ymd'</span>, time());</span><br><span class="line">        $fileDir         = <span class="keyword">__DIR__</span> . <span class="string">'/../../runtime/'</span> . <span class="string">'agentlog/'</span> . date(<span class="string">'Ym'</span>, time());</span><br><span class="line">        <span class="keyword">if</span> (!file_exists($fileDir)) &#123;</span><br><span class="line">            mkdir($fileDir, <span class="number">0777</span>, <span class="keyword">true</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        $fileName = $fileDir . <span class="string">'/'</span> . $currentDate . <span class="string">"MQ.txt"</span>;<span class="comment">//文件名称</span></span><br><span class="line">        $data     = fopen($fileName, <span class="string">'a+'</span>);<span class="comment">//添加不覆盖，首先会判断这个文件是否存在，如果不存在，则会创建该文件，即每天都会创建一个新的文件记录的信息</span></span><br><span class="line">        $val      = <span class="string">'['</span> . $currentDateTime . <span class="string">']:'</span> . $msg;</span><br><span class="line">        $val      .= <span class="string">"\n"</span>;</span><br><span class="line">        fwrite($data, $val);<span class="comment">//写入文本中</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//关闭进程</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">stop</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;channel-&gt;close();</span><br><span class="line">        <span class="keyword">$this</span>-&gt;connection-&gt;close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>消费者消费过程</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// CLI接口,需要开启守护进程</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">catch</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">//连接RabbitMQ</span></span><br><span class="line">        $RabbitMq = <span class="keyword">new</span> \app\common\RabbitMq();<span class="comment">//队列</span></span><br><span class="line">        <span class="keyword">$this</span>-&gt;logAgentWrite(<span class="string">'------------------MQ链接成功 开始整理MQ消息------------------'</span>);</span><br><span class="line">        $callback = <span class="function"><span class="keyword">function</span> <span class="params">($msg)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> $msg;</span><br><span class="line">        <span class="comment">// msg为队列内的信息流，在此处填写消费过程即可</span></span><br><span class="line">        &#125;;</span><br><span class="line">        $RabbitMq-&gt;getMessage($callback);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></li><li><p>消费者创建监听接口，用于守护进程调用</p></li></ul><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MqService</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">mqAction</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;catch(); <span class="comment">// 调用上面的catch函数，自行修改</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>至此所需要的代码就完成了</p><h2 id="消费者脚本"><a href="#消费者脚本" class="headerlink" title="消费者脚本"></a>消费者脚本</h2><h3 id="守护进程"><a href="#守护进程" class="headerlink" title="守护进程"></a>守护进程</h3><p>tips:只适用于Linux</p><p>我们在使用PHP作为消费者时，一般是使用PHP直接执行文件，使用nohup守护进程调用，但是当系统不稳定时，可能会出现各种问题导致mq队列失效，这时候就需要使用脚本监听，如果守护进程不存在，则自动重启守护进程</p><p>首先测试时可以先执行守护进程命令，例如<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nohup /usr/bin/php7.2 /alidata/workspace/test/public/index.php /api_comm/mq_service/mqAction &amp;</span><br></pre></td></tr></table></figure></p><p>路径请自行修改</p><h3 id="监听信息"><a href="#监听信息" class="headerlink" title="监听信息"></a>监听信息</h3><p>编写Shell如下</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span>!/bin/sh</span><br><span class="line">file_name="/root/restartMqService.log"  #重启脚本的日志，保证可写入，保险一点执行 chmod 777 restartMqService.log</span><br><span class="line">pid=0</span><br><span class="line">proc_num() </span><br><span class="line">&#123;</span><br><span class="line">    num=`ps -ef | grep '/usr/bin/php7.2 /alidata/workspace/test/public/index.php /api_comm/mq_service/mqAction' | grep -v grep | wc -l`  #此处'nohup /usr/bin/php7.2 /alidata/workspace/test/public/index.php /api_comm/mq_service/mqAction &amp;'替代为实际的，尽量准确，避免误kill</span><br><span class="line">    return $num </span><br><span class="line">&#125;</span><br><span class="line">proc_id()</span><br><span class="line">&#123;  </span><br><span class="line">    pid=`ps -ef | grep '/usr/bin/php7.2 /alidata/workspace/test/public/index.php /api_comm/mq_service/mqAction' | grep -v grep | awk '&#123;print $2&#125;'`  #此处'nohup /usr/bin/php7.2 /alidata/workspace/test/public/index.php /api_comm/mq_service/mqAction &amp;'也替代为实际的</span><br><span class="line">&#125; </span><br><span class="line">proc_num  #执行proc_num()，获取进程数</span><br><span class="line">number=$?  #获取上一函数返回值</span><br><span class="line">if [ $number -eq 0 ]  #如果没有该进程，则重启</span><br><span class="line">then</span><br><span class="line">    nohup /usr/bin/php7.2 /alidata/workspace/test/public/index.php /api_comm/mq_service/mqAction &amp;  #启动程序的命令</span><br><span class="line">    proc_id </span><br><span class="line">    echo $&#123;pid&#125;, `date` &gt;&gt; $file_name  #把重启的进程号、时间 写入日志</span><br><span class="line">fi</span><br></pre></td></tr></table></figure><p>将该脚本重命名为 mqMonitor.sh</p><h3 id="配置Crontab"><a href="#配置Crontab" class="headerlink" title="配置Crontab"></a>配置Crontab</h3><p>在crontab配置文件下加上一行<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">*/2 * * * * sh /root/mqMonitor.sh</span><br></pre></td></tr></table></figure></p><p>保存后重启生效，大致是2分钟监测一次，可自行修改</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;介绍&quot;&gt;&lt;a href=&quot;#介绍&quot; class=&quot;headerlink&quot; title=&quot;介绍&quot;&gt;&lt;/a&gt;介绍&lt;/h2&gt;&lt;p&gt;分布式部署，RabbitMQ(简称MQ)作为消息中间件是一个非常不错的选择，可以实现异步互不干扰的解耦操作。&lt;/p&gt;
&lt;h2 id=&quot;解决需
      
    
    </summary>
    
      <category term="优化" scheme="https://sbcoder.cn/categories/%E4%BC%98%E5%8C%96/"/>
    
    
      <category term="优化" scheme="https://sbcoder.cn/tags/%E4%BC%98%E5%8C%96/"/>
    
      <category term="消息队列" scheme="https://sbcoder.cn/tags/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97/"/>
    
      <category term="解耦" scheme="https://sbcoder.cn/tags/%E8%A7%A3%E8%80%A6/"/>
    
  </entry>
  
  <entry>
    <title>公司代码架构 - Docker + Jenkins + Gogs + Portainer(四)</title>
    <link href="https://sbcoder.cn/2019/12/14/docker_swarm.html"/>
    <id>https://sbcoder.cn/2019/12/14/docker_swarm.html</id>
    <published>2019-12-13T23:35:13.000Z</published>
    <updated>2019-12-18T12:51:18.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Portainer-Swarm-管理Docker集群"><a href="#Portainer-Swarm-管理Docker集群" class="headerlink" title="Portainer + Swarm 管理Docker集群"></a>Portainer + Swarm 管理Docker集群</h1><h2 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h2><p>Portainer是一个Docker管理工具，它支持多种方式，我们这里只写，远程链接形式和本地形式</p><h2 id="搭建环境"><a href="#搭建环境" class="headerlink" title="搭建环境"></a>搭建环境</h2><ul><li>服务器1     ：Virmach 水牛城 RAM1.8G 2C 10GSSD（黑五机器）</li><li>操作系统    ：Ubuntu16.04</li><li>部署环境    ：LNMP1.6 （我是军哥铁粉）</li></ul><p>服务器1：搭建Jenkins中转服务器，做代码自动构建使用<br>服务器2：生产环境服务器，实则测试服务器，部署代码使用<br>服务器3：Gogs服务器，Git版本库服务器，做代码版本控制使用</p><h2 id="配置Portainer"><a href="#配置Portainer" class="headerlink" title="配置Portainer"></a>配置Portainer</h2><h3 id="开放DockerAPI端口"><a href="#开放DockerAPI端口" class="headerlink" title="开放DockerAPI端口"></a>开放DockerAPI端口</h3><p>将需要加入Portainer管理的服务器（需要安装过Docker），打开2375端口，方便管理</p><p>创建一个备份，并编辑配置文件<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cp /lib/systemd/system/docker.service /lib/systemd/system/docker.service.bak </span><br><span class="line">vi /lib/systemd/system/docker.service</span><br></pre></td></tr></table></figure></p><p>方法一：<br>在ExecStart整行后面添加 -H tcp://0.0.0.0:2375，有的时候他可能不止一行，则在最后面增加这一段即可，如下<br><figure class="image-bubble">                <div class="img-lightbox">                    <div class="overlay"></div>                    <img src="https://s2.ax1x.com/2019/12/11/QsKW60.png" alt="2.png" title>                </div>                <div class="image-caption">2.png</div>            </figure><br>:wq 保存退出</p><p>方法二（推荐）：<br>本方法并不适用于所有的Docker版本<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vi /etc/docker/daemon.json</span><br></pre></td></tr></table></figure></p><p>复制以下内容<br><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"hosts"</span>: [</span><br><span class="line">        <span class="string">"tcp://0.0.0.0:2375"</span>,</span><br><span class="line">        <span class="string">"unix:///var/run/docker.sock"</span></span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>配置完后重启Docker<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl daemon-reload </span><br><span class="line">systemctl restart docker</span><br></pre></td></tr></table></figure></p><p>这里推荐大家使用iptables防火墙限制一下2375端口的访问，如果将2375暴露在公网则可能出现一系列安全问题，如果是国内的腾讯或者阿里，则可以直接在后台配置安全组，安全组里限制 指定IP访问指定端口即可，如果将2375暴露在外，则可能受到黑客恶意攻击！</p><p>如果不是国内机器，也可以通过iptables限制访问<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">iptables -I INPUT -s 107.173.XXX.XXX -p tcp --dport 2375 -j ACCEPT</span><br><span class="line">systemctl iptables.service save</span><br><span class="line">systemctl restart iptables.service</span><br><span class="line"><span class="meta">#</span> systemctl stop iptables.service 如果配置有误可以停止iptables尝试</span><br></pre></td></tr></table></figure></p><p>非常不推荐直接将2375暴露在公网，秒被黑~</p><p>配置后的效果如下图<br><figure class="image-bubble">                <div class="img-lightbox">                    <div class="overlay"></div>                    <img src="https://s2.ax1x.com/2019/12/12/QyJgud.png" alt="3.png" title>                </div>                <div class="image-caption">3.png</div>            </figure></p><h3 id="安装Portainer"><a href="#安装Portainer" class="headerlink" title="安装Portainer"></a>安装Portainer</h3><p>创建数据<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker volume create portainer_data</span><br></pre></td></tr></table></figure></p><p>创建Portainer并运行<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -d -p 8000:8000 -p 9000:9000 -v /var/run/docker.sock:/var/run/docker.sock -v portainer_data:/data portainer/portainer</span><br></pre></td></tr></table></figure></p><p>执行后访问 <a href="http://ip:9000" target="_blank" rel="noopener">http://ip:9000</a>即可看到<br><figure class="image-bubble">                <div class="img-lightbox">                    <div class="overlay"></div>                    <img src="https://s2.ax1x.com/2019/12/11/Qsn7bF.png" alt="1.png" title>                </div>                <div class="image-caption">1.png</div>            </figure><br>刚创建完会提示创建一个管理员用户，按照提示创建即可</p><p>选择创建Docker时使用Remote，远程连接，按下图填写<br><figure class="image-bubble">                <div class="img-lightbox">                    <div class="overlay"></div>                    <img src="https://s2.ax1x.com/2019/12/12/QyYn2D.png" alt="4.png" title>                </div>                <div class="image-caption">4.png</div>            </figure></p><p>添加完成后如下图，点击访问创建好的节点则可以操作里面的内容<br><figure class="image-bubble">                <div class="img-lightbox">                    <div class="overlay"></div>                    <img src="https://s2.ax1x.com/2019/12/12/QyYDZn.png" alt="5.png" title>                </div>                <div class="image-caption">5.png</div>            </figure></p><h3 id="创建Swarm集群"><a href="#创建Swarm集群" class="headerlink" title="创建Swarm集群"></a>创建Swarm集群</h3><p>在管理节点上增加Swarm集群manager节点<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker swarm init --advertise-addr [IP ADDRESS]</span><br><span class="line"><span class="meta">#</span> 例如 docker swarm init --advertise-addr 107.173.XXX.XXX</span><br></pre></td></tr></table></figure></p><p>返回结果如下，为了安全，关键位置已打码<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Swarm initialized: current node (mjjrpuemaukx5a185iqd54mka) is now a manager.</span><br><span class="line"></span><br><span class="line">To add a worker to this swarm, run the following command:</span><br><span class="line"></span><br><span class="line">    docker swarm join --token SWMTKN-1-1zd********2oci43nbf1jjhlng8k********fhfzqw2-1ywv79qnvmlb*******h3gs35r 107.173.XXX.XXX:2377</span><br><span class="line"></span><br><span class="line">To add a manager to this swarm, run &apos;docker swarm join-token manager&apos; and follow the instructions.</span><br></pre></td></tr></table></figure></p><p>当Manager节点增加完成后，可以在子节点中输入上面提示的命令以worker形式加入集群<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker swarm join --token SWMTKN-1-1zd********2oci43nbf1jjhlng8k********fhfzqw2-1ywv79qnvmlb*******h3gs35r 107.173.XXX.XXX:2377</span><br></pre></td></tr></table></figure></p><p>子节点加入成功后可以在父节点中查看子节点信息<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker node ls</span><br></pre></td></tr></table></figure></p><figure class="image-bubble">                <div class="img-lightbox">                    <div class="overlay"></div>                    <img src="https://s2.ax1x.com/2019/12/12/QycbMn.png" alt="6.png" title>                </div>                <div class="image-caption">6.png</div>            </figure><p>如果在Portainer增加manager节点，则会自动出现 Swarm 和 Service选项，如图<br><figure class="image-bubble">                <div class="img-lightbox">                    <div class="overlay"></div>                    <img src="https://s2.ax1x.com/2019/12/13/QcH3Tg.png" alt="7.png" title>                </div>                <div class="image-caption">7.png</div>            </figure></p><h2 id="结语"><a href="#结语" class="headerlink" title="结语"></a>结语</h2><p>本次搭建过程就基本完成了，我们可以通过Portainer管理之前搭建的一系列环境，至此，一套简单的公司架构就完成了，生产环境也可以做到实时构建，只需要在Gogs上面发布版本就可以了，选择手动构建，构建时选择版本号即可，这样做的好处是如果正式环境有bug时可以随时回滚到稳定版本，当然，发布版本也是建立在测试完后的场景！</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;Portainer-Swarm-管理Docker集群&quot;&gt;&lt;a href=&quot;#Portainer-Swarm-管理Docker集群&quot; class=&quot;headerlink&quot; title=&quot;Portainer + Swarm 管理Docker集群&quot;&gt;&lt;/a&gt;Portai
      
    
    </summary>
    
      <category term="架构" scheme="https://sbcoder.cn/categories/%E6%9E%B6%E6%9E%84/"/>
    
    
      <category term="优化" scheme="https://sbcoder.cn/tags/%E4%BC%98%E5%8C%96/"/>
    
      <category term="版本控制" scheme="https://sbcoder.cn/tags/%E7%89%88%E6%9C%AC%E6%8E%A7%E5%88%B6/"/>
    
      <category term="架构" scheme="https://sbcoder.cn/tags/%E6%9E%B6%E6%9E%84/"/>
    
  </entry>
  
  <entry>
    <title>公司代码架构 - Docker + Jenkins + Gogs + Portainer(三)</title>
    <link href="https://sbcoder.cn/2019/12/11/jenkins_docker.html"/>
    <id>https://sbcoder.cn/2019/12/11/jenkins_docker.html</id>
    <published>2019-12-11T11:09:38.000Z</published>
    <updated>2019-12-11T11:10:26.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="配置Jenkins实现自动构建"><a href="#配置Jenkins实现自动构建" class="headerlink" title="配置Jenkins实现自动构建"></a>配置Jenkins实现自动构建</h1><h2 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h2><p>前面已经搭建好了基本环境，剩下的就是自动构建了，这里就需要使用我们的构建工具Jenkins，Jenkins是一个非常牛逼的东西，它可以实现代码同步构建，当你修改你的代码并传到git时，Jenkins可以自动将你的代码同步到服务器上面，当然这只是Jenkins的基本功能之一，他还有非常多的东西值得我们学习~</p><h2 id="搭建环境"><a href="#搭建环境" class="headerlink" title="搭建环境"></a>搭建环境</h2><ul><li>服务器2     ：Pacificrack 洛杉矶 RAM2G 2C 35GSSD（圣诞机器）18刀</li><li>操作系统    ：CentOS7.5</li><li>部署环境    ：LNMP1.6 （我是军哥铁粉） + Java8</li></ul><p>服务器1：搭建Jenkins中转服务器，做代码自动构建使用<br>服务器2：生产环境服务器，实则测试服务器，部署代码使用<br>服务器3：Gogs服务器，Git版本库服务器，做代码版本控制使用</p><h2 id="生产环境搭建"><a href="#生产环境搭建" class="headerlink" title="生产环境搭建"></a>生产环境搭建</h2><p>服务器2的生产环境搭建。</p><p>生产环境，主要就是LNMP和Java8，LNMP是可选的，看需要部署的程序环境，例如需要部署node.js则只需要node.js环境即可，其他同理，我这边是准备自动部署PHP程序，因此就还是使用LNMP；</p><p>Java8是必须的，Jenkins使用SSH连接到服务器时是需要源服务器有Java环境的</p><h3 id="安装LNMP"><a href="#安装LNMP" class="headerlink" title="安装LNMP"></a>安装LNMP</h3><p>LNMP环境安装教程 : <a href="https://lnmp.org/install.html" target="_blank" rel="noopener">LNMP一键安装包 - 安装教程</a></p><h3 id="安装Java8"><a href="#安装Java8" class="headerlink" title="安装Java8"></a>安装Java8</h3><p>Jenkins连接节点的服务器必须安装！其他服务器无需安装！</p><p>首先更新 yum 源<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum update</span><br></pre></td></tr></table></figure></p><p>安装 jdk1.8<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install java-1.8.0-openjdk java-1.8.0-openjdk-devel</span><br></pre></td></tr></table></figure></p><p>这里注意，是可以选择Java版本的，我这里使用了8所以按照8的方式安装的</p><p>可以搜索yum选择需要安装的版本<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum search java | grep jdk</span><br></pre></td></tr></table></figure></p><p>一般 使用上面方法安装的Java配置文件都在 /etc/profile</p><p>编辑配置<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vi /etc/profile</span><br></pre></td></tr></table></figure></p><p>在末尾添加 环境变量，注意修改自己的版本号<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">JAVA_HOME=/user/lib/jvm/java-1.8.0-openjdk-1.8.0.191.b12-1.el7_6.x86_64</span><br><span class="line">JRE_HOME=$JAVA_HOME/jre</span><br><span class="line">CLASS_PATH=.:$JAVA_HOME/lib/dt.jar:$JAVA_HOME/lib/tools.jar:$JRE_HOME/lib</span><br><span class="line">PATH=$PATH:$JAVA_HOME/bin:$JRE_HOME/bin</span><br><span class="line">export JAVA_HOME JRE_HOME CLASS_PATH PATH</span><br></pre></td></tr></table></figure></p><p>重置 profile<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">source /etc/profile</span><br></pre></td></tr></table></figure></p><p>查看Java版本<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -version</span><br></pre></td></tr></table></figure></p><h2 id="Jenkins配置"><a href="#Jenkins配置" class="headerlink" title="Jenkins配置"></a>Jenkins配置</h2><h3 id="安装必要的插件"><a href="#安装必要的插件" class="headerlink" title="安装必要的插件"></a>安装必要的插件</h3><p>打开Jenkins登录后 打开 系统管理 - 插件管理 - 可选插件</p><p>搜索 安装 以下插件</p><p>汉化语言包(可选)</p><ul><li>Locale plugin      </li><li>Localization: Chinese (Simplified)</li></ul><p>Docker容器(可选)</p><ul><li>Docker Pipeline</li></ul><p>远程连接(必须)</p><ul><li>SSH plugin</li><li>SSH Slaves plugin</li><li>Oracle Java SE Development Kit Installer Plugin</li></ul><p>Git服务(推荐)</p><ul><li>GitHub plugin</li><li>Gogs plugin</li></ul><p>推荐安装(可选)</p><ul><li>bouncycastle API Plugin</li><li>Branch API Plugin</li><li>Command Agent Launcher Plugin</li></ul><p>插件属于按需配置，不适合自己的插件无需安装</p><h3 id="增加节点"><a href="#增加节点" class="headerlink" title="增加节点"></a>增加节点</h3><p>增加节点必须要先在节点服务器配置Java环境，参照上面的配置Java8环境配置！<br>如果没有配置Java环境则会报错！</p><p>增加节点必须要有SSH插件，因此如果界面与我不一样请检查自己是否安装了上面的插件</p><p>打开Jenkins 系统管理 - 节点管理 - 新建节点<br><figure class="image-bubble">                <div class="img-lightbox">                    <div class="overlay"></div>                    <img src="https://i.loli.net/2019/12/11/nRy9qOexkG3fw7N.png" alt="1.png" title>                </div>                <div class="image-caption">1.png</div>            </figure></p><p>新建节点页面如下<br><figure class="image-bubble">                <div class="img-lightbox">                    <div class="overlay"></div>                    <img src="https://i.loli.net/2019/12/11/47gwD95NBtXfOQb.png" alt="2.png" title>                </div>                <div class="image-caption">2.png</div>            </figure></p><p>如果没有设置过凭证则选择添加，界面如下<br><figure class="image-bubble">                <div class="img-lightbox">                    <div class="overlay"></div>                    <img src="https://i.loli.net/2019/12/11/LdAF3eXkqrQmuDR.png" alt="3.png" title>                </div>                <div class="image-caption">3.png</div>            </figure></p><p>全部设置完点保存，他会自动启动代理节点</p><p>首页左下角会显示状态<br><figure class="image-bubble">                <div class="img-lightbox">                    <div class="overlay"></div>                    <img src="https://i.loli.net/2019/12/11/JhEOstraiI5Lqd4.png" alt="4.png" title>                </div>                <div class="image-caption">4.png</div>            </figure></p><p>或者在节点管理里面也可以看到</p><h3 id="配置Gogs-WebHook"><a href="#配置Gogs-WebHook" class="headerlink" title="配置Gogs WebHook"></a>配置Gogs WebHook</h3><p>根据上一节我们配置好的Gogs，新建一个仓库，这里不多说，直接点加号就行，用过Github的都懂</p><p>可以选择公有仓库或者私有仓库，我这里都是私有仓库，也可以使用Gogs的迁移外部仓库功能直接迁移，迁移时可能会出现504错误，这是因为Nginx的反向代理时有超时设置，超过指定时间则直接504，我们在迁移仓库时经常会超时，因此建议修改一下默认超时时间，具体配置可以自行搜索，不多赘述。</p><p>找到需要自动构建的仓库，选择 仓库设置 - 管理 Web 钩子 - 添加Web钩子</p><figure class="image-bubble">                <div class="img-lightbox">                    <div class="overlay"></div>                    <img src="https://i.loli.net/2019/12/11/7uaGjQWqImfYXry.png" alt="6.png" title>                </div>                <div class="image-caption">6.png</div>            </figure><p>注意：图中红框处的test需要跟后面配置的Jenkins对应，例如我创建的Jenkins任务名为 test 则此处填写test，修改域名为你的Jenkins域名，其他格式一致</p><p>注意：图中秘钥可随便填写，记录下来，配置Jenkins任务时会用到</p><h3 id="配置Jenkins任务"><a href="#配置Jenkins任务" class="headerlink" title="配置Jenkins任务"></a>配置Jenkins任务</h3><p>打开 Jenkins  新建任务，如果以前没有任务则首页会显示 创建一个新任务<br><figure class="image-bubble">                <div class="img-lightbox">                    <div class="overlay"></div>                    <img src="https://i.loli.net/2019/12/11/vloscVY6eJtIK1q.png" alt="5.png" title>                </div>                <div class="image-caption">5.png</div>            </figure></p><p>配置Jenkins任务<br><figure class="image-bubble">                <div class="img-lightbox">                    <div class="overlay"></div>                    <img src="https://i.loli.net/2019/12/11/dAXcI6Y3asNbQgv.png" alt="7.png" title>                </div>                <div class="image-caption">7.png</div>            </figure></p><p>描述部分可随便填写，这里主要配置一下 Gogs Webhook</p><p>勾选 Use Gogs secret，Secret填写上面创建Gogs WebHook时的秘钥</p><p>勾选 限制项目的运行节点 ，标签表达式填写你的节点名字，例如我这里的节点名字就是我的服务器ip地址，直接填写ip地址即可</p><figure class="image-bubble">                <div class="img-lightbox">                    <div class="overlay"></div>                    <img src="https://i.loli.net/2019/12/11/LX5pBVqgk7du6no.png" alt="8.png" title>                </div>                <div class="image-caption">8.png</div>            </figure><p>源码管理选择Git，Repository URL选择需要自动构建的Git项目地址，http形式的，Credentials处为验证，如果是公共仓库则无需配置，如果是私有库则需要填写登录到 Gogs 的账户和密码，配置与之前的节点配置凭据一样，不多赘述</p><p>指定分支填写需要自动构建的分支，我这里填写的是dev分支，用来做开发版测试使用，根据自己情况来即可</p><h2 id="配置上线"><a href="#配置上线" class="headerlink" title="配置上线"></a>配置上线</h2><h3 id="Nginx配置"><a href="#Nginx配置" class="headerlink" title="Nginx配置"></a>Nginx配置</h3><p>由于我创建的节点 目录地址是 /home/wwwroot</p><p>在项目自动构建时，则会自动创建目录 /home/wwwroot/workspace/[JOB NAME]<br>JOB NAME 为 任务名，例如我的 test 则自动创建目录 /home/wwwroot/workspace/test</p><p>Nginx则只需要配置  域名解析即可</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lnmp vhost add</span><br></pre></td></tr></table></figure><figure class="image-bubble">                <div class="img-lightbox">                    <div class="overlay"></div>                    <img src="https://s2.ax1x.com/2019/12/11/QsEMVA.png" alt="9.png" title>                </div>                <div class="image-caption">9.png</div>            </figure><p>按图上配置即可，建议增加SSL证书，增加证书前记得先把域名解析到指定服务器IP上，否则会生成证书失败</p><p>记得给文件夹加上权限，755</p><h3 id="构建"><a href="#构建" class="headerlink" title="构建"></a>构建</h3><p>返回Jenkins，点击立即构建，第一次构建时间可能会长一些，等待即可!</p><p>构建完成后则会在 配置的目录下创建workspace目录，并将代码放入 /home/wwwroot/workspace/test 目录中，根据自己的配置自行修改目录</p><p>由于我的程序涉及到跨目录访问，因此需要更改 fastcgi.conf 文件，与本文无关这里不多说~</p><p>附一张成功截图，由于我这是前后端分离项目，因此没有界面~<br><figure class="image-bubble">                <div class="img-lightbox">                    <div class="overlay"></div>                    <img src="https://s2.ax1x.com/2019/12/11/QsV5wj.png" alt="10.png" title>                </div>                <div class="image-caption">10.png</div>            </figure></p><h3 id="自动构建"><a href="#自动构建" class="headerlink" title="自动构建"></a>自动构建</h3><p>上面已经配置好了自动构建，我们每次合并代码或者提交代码变更到dev分支时，Gogs则会以Webhook的形式将内容推送到Jenkins上面去，实现每次更新代码自动构建服务器代码。</p><h2 id="结语"><a href="#结语" class="headerlink" title="结语"></a>结语</h2><p>目前搭建好的架构，适合还在开发测试程序的开发小组，配合测试人员使用，也能让产品们在汇报工作进度的时候更得心应手，了解开发进度，当然也不是特别准确的开发进度，摸鱼还是要摸的。后面应该会写一下 Portainer + Swarm 管理Docker集群，慢慢写~</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;配置Jenkins实现自动构建&quot;&gt;&lt;a href=&quot;#配置Jenkins实现自动构建&quot; class=&quot;headerlink&quot; title=&quot;配置Jenkins实现自动构建&quot;&gt;&lt;/a&gt;配置Jenkins实现自动构建&lt;/h1&gt;&lt;h2 id=&quot;介绍&quot;&gt;&lt;a href=&quot;
      
    
    </summary>
    
      <category term="架构" scheme="https://sbcoder.cn/categories/%E6%9E%B6%E6%9E%84/"/>
    
    
      <category term="优化" scheme="https://sbcoder.cn/tags/%E4%BC%98%E5%8C%96/"/>
    
      <category term="版本控制" scheme="https://sbcoder.cn/tags/%E7%89%88%E6%9C%AC%E6%8E%A7%E5%88%B6/"/>
    
      <category term="架构" scheme="https://sbcoder.cn/tags/%E6%9E%B6%E6%9E%84/"/>
    
  </entry>
  
  <entry>
    <title>公司代码架构 - Docker + Jenkins + Gogs + Portainer(二)</title>
    <link href="https://sbcoder.cn/2019/12/10/gogs_docker.html"/>
    <id>https://sbcoder.cn/2019/12/10/gogs_docker.html</id>
    <published>2019-12-10T11:05:36.000Z</published>
    <updated>2019-12-10T11:07:02.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="安装-Gogs-Docker常用命令"><a href="#安装-Gogs-Docker常用命令" class="headerlink" title="安装 Gogs + Docker常用命令"></a>安装 Gogs + Docker常用命令</h1><h2 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h2><p>本节主要写一下Jenkins的配置与自动构建过程，包括使用Gogs作为git服务器，配置自动构建等。<br>本节需要配合上一节的内容使用，即 安装 Docker + Jenkins 的服务器一台</p><h2 id="搭建环境"><a href="#搭建环境" class="headerlink" title="搭建环境"></a>搭建环境</h2><ul><li>服务器3     ：TencentCloud 北京 RAM4G 2C 40GSSD（新用户机器）998RMB/3Year</li><li>操作系统    ：CentOS7.5</li><li>部署环境    ：LNMP1.6 （我是军哥铁粉）</li></ul><p>服务器1：搭建Jenkins中转服务器，做代码自动构建使用<br>服务器2：生产环境服务器，实则测试服务器，部署代码使用<br>服务器3：Gogs服务器，Git版本库服务器，做代码版本控制使用</p><p>配置无需对标，都是低配置小鸡，唯一一个腾讯云 2C4G 的机器是我之前放其他业务的机器，由于git经常需要使用因此搭建在国内套CloudFlare使用，实则Gogs只需要 2C1G 机器即可，官方推荐配置是2C512M，是一个不吃内存的程序，目前腾讯云的 1C2G 只需要99/年，属于大众所承受的起的价格，由于我不是专职AFFMAN，因此不贴链接</p><h2 id="CentOS7-安装-Docker"><a href="#CentOS7-安装-Docker" class="headerlink" title="CentOS7 安装 Docker"></a>CentOS7 安装 Docker</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum -y install docker</span><br></pre></td></tr></table></figure><figure class="image-bubble">                <div class="img-lightbox">                    <div class="overlay"></div>                    <img src="https://i.loli.net/2019/12/10/Q8blCz9rTSN7tqB.png" alt="1.png" title>                </div>                <div class="image-caption">1.png</div>            </figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">start docker</span><br><span class="line">enable docker</span><br></pre></td></tr></table></figure><figure class="image-bubble">                <div class="img-lightbox">                    <div class="overlay"></div>                    <img src="https://i.loli.net/2019/12/10/DEwP32bkWKcJS6l.png" alt="2.png" title>                </div>                <div class="image-caption">2.png</div>            </figure><p>查看版本号，查看是否安装成功！<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker -v</span><br></pre></td></tr></table></figure></p><figure class="image-bubble">                <div class="img-lightbox">                    <div class="overlay"></div>                    <img src="https://i.loli.net/2019/12/10/uGs24UWEbvRlO8N.png" alt="3.png" title>                </div>                <div class="image-caption">3.png</div>            </figure><h3 id="Docker-常用命令"><a href="#Docker-常用命令" class="headerlink" title="Docker 常用命令"></a>Docker 常用命令</h3><p>记录一下安装时可能会出现的问题，以及常用的Docker命令</p><p>查看当前运行的容器<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker ps</span><br></pre></td></tr></table></figure></p><p>查看所有容器<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker ps -a</span><br></pre></td></tr></table></figure></p><p>停止容器<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker stop [DOCKER NAME] </span><br><span class="line"><span class="meta">#</span> 例如：docker stop gogs</span><br></pre></td></tr></table></figure></p><p>删除容器(必须在Stop之后才可以删除)<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker rm [DOCKER NAME] </span><br><span class="line"><span class="meta">#</span> 例如：docker rm gogs</span><br></pre></td></tr></table></figure></p><p>进入容器<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">docker attach [DOCKER NAME] </span><br><span class="line"><span class="meta">#</span> 例如： docker attach gogs</span><br><span class="line">docker exec -it [DOCKER IMAGE ID] /bin/bash</span><br><span class="line"><span class="meta">#</span> 例如： docker exec -it ef5cb0692b57 /bin/bash</span><br></pre></td></tr></table></figure></p><p>退出容器<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">exit</span><br></pre></td></tr></table></figure></p><p>查看容器变动日志<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker diff [DOCKER NAME]</span><br><span class="line"><span class="meta">#</span> 例如：docker diff gogs</span><br></pre></td></tr></table></figure></p><p>查看容器或者镜像详细信息<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo docker inspect [IMAGE NAME]:0.1 </span><br><span class="line"><span class="meta">#</span> 例如： sudo docker inspect gogs</span><br></pre></td></tr></table></figure></p><p>向容器内部发送指令<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker exec [DOCKER NAME] [COMMAND]</span><br><span class="line"><span class="meta">#</span> 例如 docker exec gogs ls</span><br></pre></td></tr></table></figure></p><h2 id="安装-Gogs"><a href="#安装-Gogs" class="headerlink" title="安装 Gogs"></a>安装 Gogs</h2><h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><p>下载镜像 Gogs<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker pull gogs/gogs</span><br></pre></td></tr></table></figure></p><figure class="image-bubble">                <div class="img-lightbox">                    <div class="overlay"></div>                    <img src="https://i.loli.net/2019/12/10/2HbjfQsEygriOe9.png" alt="4.png" title>                </div>                <div class="image-caption">4.png</div>            </figure><p>创建目录<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /home/Gogs</span><br><span class="line">cd /home/Gogs</span><br></pre></td></tr></table></figure></p><figure class="image-bubble">                <div class="img-lightbox">                    <div class="overlay"></div>                    <img src="https://i.loli.net/2019/12/10/E6t9KsZXg7TwFO3.png" alt="5.png" title>                </div>                <div class="image-caption">5.png</div>            </figure><p>开启Docker<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span> 直接启动</span><br><span class="line">docker run --name=gogs -p 10022:22 -p 10080:3000 -v /home/Gogs:/data gogs/gogs</span><br><span class="line"><span class="meta">#</span> 后台启动</span><br><span class="line">docker run --name=gogs -d  -p 10022:22 -p 10080:3000 -v /home/Gogs:/data gogs/gogs</span><br></pre></td></tr></table></figure></p><h3 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h3><p>正常启动后直接打开 <a href="http://ip:10080" target="_blank" rel="noopener">http://ip:10080</a>即可</p><p>如图：</p><figure class="image-bubble">                <div class="img-lightbox">                    <div class="overlay"></div>                    <img src="https://i.loli.net/2019/12/10/eTy2A1EksPLdxlZ.png" alt="6.png" title>                </div>                <div class="image-caption">6.png</div>            </figure><p>接下来按照提示配置即可，我们这里使用SQLite3</p><p>应用配置需要注意一下</p><ul><li>域名填写你的服务器公网IP</li><li>SSH端口号填写 映射的端口号 10022</li><li>HTTP端口号填写 3000</li><li>应用URL填写 ip + 映射的端口号 10080 访问<figure class="image-bubble">                <div class="img-lightbox">                    <div class="overlay"></div>                    <img src="https://i.loli.net/2019/12/10/4FveSlBTdIVO5tA.png" alt="7.png" title>                </div>                <div class="image-caption">7.png</div>            </figure></li></ul><p>配置完成后如果设置好管理员账户的会自动登录进去，如果没有设置的可以自行注册。</p><p>注意：数据库中第一个用户就是管理员账户<br><figure class="image-bubble">                <div class="img-lightbox">                    <div class="overlay"></div>                    <img src="https://i.loli.net/2019/12/10/oQylDbdHcfOgL1j.png" alt="8.png" title>                </div>                <div class="image-caption">8.png</div>            </figure></p><p>Tips：Gogs的配置文件存放在 Docker中的 /data/gogs/conf/app.ini 如果想要更改可以</p><h3 id="反向代理绑定域名"><a href="#反向代理绑定域名" class="headerlink" title="反向代理绑定域名"></a>反向代理绑定域名</h3><p>同 <a href="https://sbcoder.cn/2019/12/09/code_build.html#Nginx%E5%8F%8D%E4%BB%A3Jenkins%EF%BC%8C%E7%BB%91%E5%AE%9A%E5%9F%9F%E5%90%8D">公司代码架构 - Docker + Jenkins + Gogs + Portainer(一)</a>一样，在应用配置阶段修改或者修改配置文件都可以</p><h2 id="结语"><a href="#结语" class="headerlink" title="结语"></a>结语</h2><p>Gogs 是一个轻量级的 Git服务器，适用于一些小公司小团队使用，大公司使用Gitlab的情况可能更多一些，但是东西实际都是差不多的，为了占用资源更小一些，我这里还是选用了比较轻量级的Gogs</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;安装-Gogs-Docker常用命令&quot;&gt;&lt;a href=&quot;#安装-Gogs-Docker常用命令&quot; class=&quot;headerlink&quot; title=&quot;安装 Gogs + Docker常用命令&quot;&gt;&lt;/a&gt;安装 Gogs + Docker常用命令&lt;/h1&gt;&lt;h2 i
      
    
    </summary>
    
      <category term="架构" scheme="https://sbcoder.cn/categories/%E6%9E%B6%E6%9E%84/"/>
    
    
      <category term="优化" scheme="https://sbcoder.cn/tags/%E4%BC%98%E5%8C%96/"/>
    
      <category term="版本控制" scheme="https://sbcoder.cn/tags/%E7%89%88%E6%9C%AC%E6%8E%A7%E5%88%B6/"/>
    
      <category term="架构" scheme="https://sbcoder.cn/tags/%E6%9E%B6%E6%9E%84/"/>
    
  </entry>
  
  <entry>
    <title>公司代码架构 - Docker + Jenkins + Gogs + Portainer(一)</title>
    <link href="https://sbcoder.cn/2019/12/09/code_build.html"/>
    <id>https://sbcoder.cn/2019/12/09/code_build.html</id>
    <published>2019-12-09T11:47:26.000Z</published>
    <updated>2019-12-10T11:07:37.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="公司代码架构-Docker-Jenkins-Gogs-Portainer-一"><a href="#公司代码架构-Docker-Jenkins-Gogs-Portainer-一" class="headerlink" title="公司代码架构 - Docker + Jenkins + Gogs + Portainer(一)"></a>公司代码架构 - Docker + Jenkins + Gogs + Portainer(一)</h1><h2 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h2><p>公司研发项目时，遇到git作为版本控制时，很常见的问题是部署比较麻烦（相比较麻烦），需要先克隆在拉到服务器部署，代码提交频率过高时，就会出现一天很多次提交代码，部署代码，浪费了大量的人力物力，于是乎大量的架构师技术总监们开始研究各类解决方案，各种上线前review代码，这是一件非常痛苦的事情，这里简单记录一下公司代码架构的部署，来解决公司代码架构上的诸多问题，也是自己做一个笔记，文章内如有错误，还请各位指出。</p><p>Tips：该环境并不适用于个人用户以及小微企业，适用于项目众多且开发人员大于30人的公司</p><h2 id="搭建环境"><a href="#搭建环境" class="headerlink" title="搭建环境"></a>搭建环境</h2><ul><li>服务器1  ：Virmach 水牛城 RAM1.8G 2C 10GSSD（黑五机器）</li><li>操作系统  ：Ubuntu16.04</li><li>部署环境  ：LNMP1.6 （我是军哥铁粉）</li></ul><p>这里说明一下，多台服务器是为了解耦，说是解耦，实则认为承受不住，且大部分公司已经有一套完整的git服务器了，本节要做的就是加个自动构建而已，git服务器可自选环境，后面会讲如何搭建Gogs，如果有高配置服务器的公司或个人，可以尝试使用单服务器多部署，本文所需共三台服务器。</p><p>服务器1：搭建Jenkins中转服务器，做代码自动构建使用<br>服务器2：生产环境服务器，实则测试服务器，部署代码使用<br>服务器3：Gogs服务器，Git版本库服务器，做代码版本控制使用</p><p><strong>服务器1的配置属于中下配置，该机型一年 13刀，属于大部分人都承受的起的价格，请注意，本文标注的配置仅用于配置自动构建服务器，并不用于部署代码以及Git服务，个人用户小鸡多的可以尝试</strong></p><h2 id="Ubuntu16-04-Ubuntu18-04-安装-Docker"><a href="#Ubuntu16-04-Ubuntu18-04-安装-Docker" class="headerlink" title="Ubuntu16.04/Ubuntu18.04 安装 Docker"></a>Ubuntu16.04/Ubuntu18.04 安装 Docker</h2><p>Docker可以说是非常的牛X了，关于他的概念不多说，牛就牛在管理太方便了，就好像是 WHMCS 用母鸡开小鸡一样，母鸡永远不考虑小鸡的运作，只需要配合就好，Docker也一样，我们只需要创建容器，管理容器就够了，剩下的交给Docker来处理，且Docker可以做负载均衡，后续做架构的时候可以开多个Docker做集群，按需来做</p><h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><p>删除旧版本，更新apt-get，安装docker<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get remove docker docker-engine docker-ce docker.io</span><br><span class="line">sudo apt-get update</span><br><span class="line">sudo apt install docker.io</span><br></pre></td></tr></table></figure></p><h3 id="启动Docker并查看版本"><a href="#启动Docker并查看版本" class="headerlink" title="启动Docker并查看版本"></a>启动Docker并查看版本</h3><p>启动docker<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">systemctl start docker</span><br><span class="line">systemctl enable docker</span><br><span class="line">docker --version</span><br></pre></td></tr></table></figure></p><p>我这里安装的是 18.09版本</p><figure class="image-bubble">                <div class="img-lightbox">                    <div class="overlay"></div>                    <img src="https://i.loli.net/2019/12/09/IQyH1zd8wpDJiSl.png" alt="Docker1.png" title>                </div>                <div class="image-caption">Docker1.png</div>            </figure><h2 id="安装Jenkins"><a href="#安装Jenkins" class="headerlink" title="安装Jenkins"></a>安装Jenkins</h2><h3 id="安装-1"><a href="#安装-1" class="headerlink" title="安装"></a>安装</h3><p>安装Jenkins可以选择多种方式安装，我这里采用的是Docker的方式安装的，由于我们上面已经安装过Docker，按照Jenkins官方给的安装方案就可以了，首先pull一个稳定版本的 Jenkins 镜像<br>镜像地址 : <a href="https://hub.docker.com/r/jenkinsci/blueocean/" target="_blank" rel="noopener">jenkinsci/blueocean</a><br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker pull jenkinsci/blueocean</span><br><span class="line">docker images</span><br></pre></td></tr></table></figure></p><figure class="image-bubble">                <div class="img-lightbox">                    <div class="overlay"></div>                    <img src="https://i.loli.net/2019/12/09/sOuchdt4Xa2EZCN.png" alt="Docker2.png" title>                </div>                <div class="image-caption">Docker2.png</div>            </figure><p>查看当前Jenkins版本<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker inspect [IMAGE ID]</span><br></pre></td></tr></table></figure></p><p>这里的 IMAGE ID 则是上面 查看镜像的 IMAGE ID<br><figure class="image-bubble">                <div class="img-lightbox">                    <div class="overlay"></div>                    <img src="https://i.loli.net/2019/12/09/6KpsuV2xYUROPXa.png" alt="Jenkins1.png" title>                </div>                <div class="image-caption">Jenkins1.png</div>            </figure><br>红框内则是 对应版本号</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span> 创建一个存放Jenkins Docker的目录</span><br><span class="line">mkdir /home/root/Jenkins</span><br><span class="line"><span class="meta">#</span> 启动一个Docker</span><br><span class="line">docker run -d --name jenkins -p 8081:8080 -v /home/jenkins:/home/jenkins jenkins/jenkins:lts</span><br><span class="line"><span class="meta">#</span> 查看jenkins服务</span><br><span class="line">docker ps | grep jenkins</span><br></pre></td></tr></table></figure><figure class="image-bubble">                <div class="img-lightbox">                    <div class="overlay"></div>                    <img src="https://i.loli.net/2019/12/09/vtdZiLsepn9Hkag.png" alt="Jenkins2.png" title>                </div>                <div class="image-caption">Jenkins2.png</div>            </figure><p>打开 <a href="http://IP:8081" target="_blank" rel="noopener">http://IP:8081</a><br><figure class="image-bubble">                <div class="img-lightbox">                    <div class="overlay"></div>                    <img src="https://i.loli.net/2019/12/09/yEO6u195Xw2Z348.png" alt="Jenkins3.png" title>                </div>                <div class="image-caption">Jenkins3.png</div>            </figure></p><p>输入命令进入 Docker内部<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker exec -it jenkins bash</span><br><span class="line"><span class="meta">#</span> 获取密码</span><br><span class="line">cat /var/jenkins_home/secrets/initialAdminPassword</span><br></pre></td></tr></table></figure></p><p>重启Docker<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker restart [CONTAINER ID]</span><br></pre></td></tr></table></figure></p><p>[CONTAINER ID] 为当前Jenkins的版本号 例如 2.164.3 则输入 docker restart 2.164.3</p><h3 id="Nginx反代Jenkins，绑定域名"><a href="#Nginx反代Jenkins，绑定域名" class="headerlink" title="Nginx反代Jenkins，绑定域名"></a>Nginx反代Jenkins，绑定域名</h3><p>由于众所周知的水牛城服务器卡，国内环境必须搭配CloudFlare才可以使用，否则太卡了，因此安装LNMP环境，后续自动构建时也可以构建到这里</p><ul><li>安装方法一：</li></ul><p>LNMP环境安装教程 : <a href="https://lnmp.org/install.html" target="_blank" rel="noopener">LNMP一键安装包 - 安装教程</a></p><p>懒得打开的话，可以直接输入<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget http://soft.vpser.net/lnmp/lnmp1.6.tar.gz -cO lnmp1.6.tar.gz &amp;&amp; tar zxf lnmp1.6.tar.gz &amp;&amp; cd lnmp1.6 &amp;&amp; ./install.sh lnmp</span><br></pre></td></tr></table></figure></p><p>我这里安装的是 1.6稳定版，需要其他版本的可以自行修改版本号安装</p><ul><li>安装方法二：</li></ul><p>apt-get安装，建议先更新apt-get<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">apt-get install nginx</span><br></pre></td></tr></table></figure></p><p>打开NGINX配置文件目录，创建一个新的配置文件(这里是lnmp环境的配置文件地址，apt-get安装的nginx配置文件存放于 /etc/nginx/conf.d 中)</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vi /usr/local/nginx/conf/vhost/jenkins.conf</span><br></pre></td></tr></table></figure><p>输入以下内容，请注意替换掉下面的 jenkins.0161.org<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">        listen       80;</span><br><span class="line">        server_name  jenkins.0161.org;</span><br><span class="line">        client_max_body_size 60M;</span><br><span class="line">        client_body_buffer_size 512k;</span><br><span class="line">        location / &#123;</span><br><span class="line">                proxy_pass</span><br><span class="line">                http://localhost:8081;</span><br><span class="line">                proxy_redirect  off;</span><br><span class="line">                proxy_set_header Host $host;</span><br><span class="line">                proxy_set_header X-Real-IP $remote_addr;</span><br><span class="line">                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>重启lnmp使配置生效<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lnmp reload</span><br></pre></td></tr></table></figure></p><p>打开CloudFlare绑定域名，增加CDN支持，此处比较简单，不多赘述</p><h2 id="结语"><a href="#结语" class="headerlink" title="结语"></a>结语</h2><p>一个完整的架构，需要很多的付出，并非一朝一夕，本文所属架构并不适用于所有公司或者个人，大型公司还需要K8s集群，承受多少并发取决于很多因素，任何架构都不能通杀所有类型的公司</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;公司代码架构-Docker-Jenkins-Gogs-Portainer-一&quot;&gt;&lt;a href=&quot;#公司代码架构-Docker-Jenkins-Gogs-Portainer-一&quot; class=&quot;headerlink&quot; title=&quot;公司代码架构 - Docker 
      
    
    </summary>
    
      <category term="架构" scheme="https://sbcoder.cn/categories/%E6%9E%B6%E6%9E%84/"/>
    
    
      <category term="优化" scheme="https://sbcoder.cn/tags/%E4%BC%98%E5%8C%96/"/>
    
      <category term="版本控制" scheme="https://sbcoder.cn/tags/%E7%89%88%E6%9C%AC%E6%8E%A7%E5%88%B6/"/>
    
      <category term="架构" scheme="https://sbcoder.cn/tags/%E6%9E%B6%E6%9E%84/"/>
    
  </entry>
  
  <entry>
    <title>开发中常见的MySQL数据库优化细节</title>
    <link href="https://sbcoder.cn/2019/06/20/mysql_optimize.html"/>
    <id>https://sbcoder.cn/2019/06/20/mysql_optimize.html</id>
    <published>2019-06-20T10:17:03.000Z</published>
    <updated>2019-12-09T11:51:26.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>以我的习惯来讲，每开始一个新的项目都需要先把思路完善，紧接着就需要建立数据库，在码代码的时候，就一般不会在修改数据库的构造了，因此，数据库的结构通常关乎着查询的速度以及程序的完善程度，一个好的结构可以让你少写很多代码，也能让程序的运行速度更加快，通常在大公司都是由DBA来做这件事，但是事无绝对，作为一名合格的后端，掌握一些少量的数据库优化也是很需要的。</p><h1 id="MySQL优化-数据类型及CURD"><a href="#MySQL优化-数据类型及CURD" class="headerlink" title="MySQL优化 - 数据类型及CURD"></a>MySQL优化 - 数据类型及CURD</h1><h2 id="PROCEDURE-ANALYSE"><a href="#PROCEDURE-ANALYSE" class="headerlink" title="PROCEDURE ANALYSE()"></a>PROCEDURE ANALYSE()</h2><p>PROCEDURE ANALYSE() [prəˈsējər ˈænəlaɪz]是一个MySQL自带的给我们提供数据库优化建议的函数，他可以直接运行在MySQL中，直接在执行语句中加上这个函数即可<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span>  <span class="string">`list`</span> <span class="keyword">WHERE</span> <span class="number">1</span> <span class="keyword">PROCEDURE</span> ANALYSE ( )</span><br></pre></td></tr></table></figure></p><p>这段SQL执行过后，将会把list表中的数据分析一遍，并把他的分析结果展示出来</p><table><tr><th>Field_name</th><th>Min_value</th><th>Max_value</th><th>Min_length</th><th>Max_length</th></tr><tr><th>Empties_or_zeros</th><th>Nulls</th><th>Avg_value_oravg_length</th><th>std</th><th>Optimal_fieldtype</th></tr></table><p>他将会把分析出来的 字段名 最短值 最大值 以及最后一列就是MySQL给出的分析结果，我们可以在有一定数据的时候使用这个函数来分析，这样给出的结果会更精确一些，只需要查看最后一列Optimal_fieldtype的值即可，这个函数并不适用于数据库设计阶段，它适用于后期使用</p><h2 id="EXPLAIN"><a href="#EXPLAIN" class="headerlink" title="EXPLAIN"></a>EXPLAIN</h2><p>EXPLAIN是一个非常好用的MySQL语法，在我们功能测试阶段，如果发现某页面非常慢，排除静态资源问题后就可以试试使用EXPLAIN，我们可以在执行语句前面加上 EXPLAIN 来获得执行过程，通过该结果我们可以看到SQL如何改变会减少查询时间和次数。<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">EXPLAIN</span> <span class="keyword">SELECT</span> * <span class="keyword">FROM</span>  <span class="string">`list`</span> <span class="keyword">WHERE</span> <span class="number">1</span></span><br></pre></td></tr></table></figure></p><p>这段SQL执行后，将会返回如下格式的分析结果</p><table><thead><tr><th>id</th><th>select_type</th><th>table</th><th>type</th><th>possible_keys</th><th>key</th><th>key_len</th><th>ref</th><th>rows</th><th>Extra</th></tr></thead></table><p>我们主要看rows就行，为了得到想要的结果，rows的值越小越好，使用EXPLAIN来调试简直是再好不过了！</p><h2 id="ENUM-枚举-类型"><a href="#ENUM-枚举-类型" class="headerlink" title="ENUM(枚举)类型"></a>ENUM(枚举)类型</h2><p>很多程序员往往喜欢统一一个数据类型，比如说 ‘varchar’ ，这可能是我见过最多的数据类型了，早些时期，的确是有很多的公司或者程序都是大面积使用，随着MySQL的革新换代，很多的类型都可以避免使用它。<br>我在很多得程序上测试过（有数据）PROCEDURE ANALYSE()方法，他给出了很多 ‘varchar’ 替换为 ‘enum’ 的建议，这说明，enum类型的确是一个应该被重视的数据类型，但由于他是一个枚举类型，我们在定义数据类型的时候并不适合直接上手定义，所以很多时候都是在有一定的数据量的时候才想要换数据类型的。<br>可以理解为枚举即时索引，枚举就相当于给这个字段的可能值都加上了一个索引，与我们为了优化查询加索引是一样的概念。<br>enum更适用于选项卡类字段，例如性别，订单状态等，如果您字段中只有几个重复的值也是非常推荐使用的。</p><h2 id="JOIN"><a href="#JOIN" class="headerlink" title="JOIN"></a>JOIN</h2><p>链接查询，这是我们在开发中非常常用的查询方式，首先要知道，我们在学校里学习的大多数是 AND 链接多表查询，虽然能够将结果无误的查询出来，但是速度就影响的非常多了，这里还是推荐大家使用JOIN来连接查询<br>有些同学可能不太理解JOIN，简单说一下JOIN的内连接和外链接，左外链接和右外链接吧</p><p>内连接即是A B两表链接，只取两表共有的数据，假设 B 中 有的数据 A 表内没有对应的数据则无法查询到</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> list1 <span class="keyword">INNER</span> <span class="keyword">JOIN</span> list2 <span class="keyword">on</span> list1.id = list2.id</span><br></pre></td></tr></table></figure><p>外连接（FULL JOIN 也称作全连接）即是A B两表链接，取两表所有的数据，即使 B 表中的某些数据无法匹配链接条件时，也正常链接</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> list1 <span class="keyword">FULL</span> <span class="keyword">JOIN</span> list2 <span class="keyword">on</span> list1.id = list2.id</span><br></pre></td></tr></table></figure><p>左外连接，即是 A B两表链接，取两表所有数据，若A表中有B表不匹配的数据，同样展示出来，B表如果有A不匹配的数据，则不展示</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> list1 <span class="keyword">LEFT</span> <span class="keyword">OUTER</span> <span class="keyword">JOIN</span> list2 <span class="keyword">on</span> list1.id = list2.id</span><br></pre></td></tr></table></figure><p>右外连接，即是 A B两表链接，取两表所有数据，若B表中有A表不匹配的数据，同样展示出来，A表如果有B不匹配的数据，则不展示，与左外连接相反</p><figure class="image-bubble">                <div class="img-lightbox">                    <div class="overlay"></div>                    <img src="https://s2.ax1x.com/2019/06/20/VvmQFU.png" alt="VvmQFU.png" title>                </div>                <div class="image-caption">VvmQFU.png</div>            </figure><h1 id="MySQL优化-结构"><a href="#MySQL优化-结构" class="headerlink" title="MySQL优化 - 结构"></a>MySQL优化 - 结构</h1><h2 id="FULLTEXT-INDEX"><a href="#FULLTEXT-INDEX" class="headerlink" title="FULLTEXT INDEX"></a>FULLTEXT INDEX</h2><p>FULLTEXT INDEX(全文索引)，更适用于文章内容搜索的索引，我们在作搜索功能的时候，很多人喜欢将文章内容(content)建立普通索引，但是实际上，这种做法并不会增加查询速度，通常我们做搜索的时候，执行下列语句。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="keyword">content</span> <span class="keyword">FROM</span>  <span class="string">`list`</span> <span class="keyword">WHERE</span> <span class="keyword">content</span> <span class="keyword">LIKE</span> <span class="string">'%风向标%'</span></span><br></pre></td></tr></table></figure><p>如果搜索功能权重比较高的网站，就需要将content这个字段建立索引。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span>  <span class="string">`list`</span> <span class="keyword">ADD</span> FULLTEXT (<span class="string">`content`</span>)</span><br></pre></td></tr></table></figure><p>如果是phpmyadmin用户，在phpmyadmin中直接点击’全文搜索’即可。</p><h2 id="MyISAM-OR-InnoDB？"><a href="#MyISAM-OR-InnoDB？" class="headerlink" title="MyISAM OR InnoDB？"></a>MyISAM OR InnoDB？</h2><p>就我现阶段写出来的东西来看（数据量小，查询次数少，用户量较少），MyISAM肯定是最适合我的，它更适用于小型网站，以及事务处理较少的网站<br>InnoDB则与之相反，如果你的业务比较复杂，针对数据库的操作较多的时候，InnoDB就会更适合一些。<br>使用INSERT插入数据时 MyISAM 就比 InnoDB 更快一些，而 UPDATE 时 InnoDB 就会比 MyISAM 快一些</p><p>如果您是轻度SQL用户，重功能不重视业务的项目，那么我个人以为 MyISAM 更适合一些<br>如果您感觉业务逻辑复杂，经常使用SQL，那么可以尝试使用 InnoDB</p><p>最后也是见仁见智，没有好坏，如果您希望测试，也是可以通过直接修改数据库引擎来测试速度的</p><h1 id="MySQL优化-小知识点"><a href="#MySQL优化-小知识点" class="headerlink" title="MySQL优化 - 小知识点"></a>MySQL优化 - 小知识点</h1><ul><li>不要使用 SELECT * 查询</li><li>不要使用 NULL</li><li>频繁查询的字段建立索引</li><li>索引过多时会影响 UPDATE 和 INSERT 的执行速度</li><li>避免在 WHERE 时使用 != &lt;&gt; 等操作符，MySQL会自动放弃索引，直接全表扫描</li><li>避免使用 IN 和 NOT IN，尽量使用BETWEEN，MySQL会自动放弃索引，直接全表扫描</li><li>可以使用 EXISTS 来代替 IN 使用</li><li>某些情况下可以使用强制使用索引查询 SELECT * FROM list with(index(索引名)) WHERE ….</li><li>避免使用 OR 作为调件，可以使用 UNION 并集查询将两次查询结果合并</li><li>尽可能将表内容长度固定</li><li>查询时如果只查询一条信息，就使用 LIMIT 1</li><li>避免使用比较表达式 如 10000+1 = id 可以使用 id = 10000+1</li><li>记得将查询链接即时关闭掉</li><li>使用变量来给MySQL开启查询缓存，避免使用MySQL内置变量函数</li><li>设置的主键尽量使用长度短且最好是int类型</li><li>垂直分割，将大量的字段的表优化成多个少字段的表</li><li>INSERT 和 DELETE 是一个可以锁定数据表的SQL语句，必须等待执行完毕后才会解除锁定，如果这条语句执行起来过于缓慢，请谨慎使用</li><li>Object Relational Mapper</li><li>Prepared Statements</li></ul><p>参考:  <a href="https://code.tutsplus.com/tutorials/top-20-mysql-best-practices--net-7855" target="_blank" rel="noopener">Top 20+ MySQL Best Practices</a><br>参考:  <a href="https://www.liaoxuefeng.com/wiki/1177760294764384/1179610888796448" target="_blank" rel="noopener">廖雪峰的个人网站 - 链接查询</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h1&gt;&lt;p&gt;以我的习惯来讲，每开始一个新的项目都需要先把思路完善，紧接着就需要建立数据库，在码代码的时候，就一般不会在修改数据库的构造了，因此，数据库的
      
    
    </summary>
    
      <category term="优化" scheme="https://sbcoder.cn/categories/%E4%BC%98%E5%8C%96/"/>
    
    
      <category term="优化" scheme="https://sbcoder.cn/tags/%E4%BC%98%E5%8C%96/"/>
    
      <category term="MySQL" scheme="https://sbcoder.cn/tags/MySQL/"/>
    
  </entry>
  
  <entry>
    <title>mm131全栈多线程爬虫</title>
    <link href="https://sbcoder.cn/2019/06/19/mm131_spider.html"/>
    <id>https://sbcoder.cn/2019/06/19/mm131_spider.html</id>
    <published>2019-06-19T14:34:31.000Z</published>
    <updated>2019-06-19T14:56:33.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="起因"><a href="#起因" class="headerlink" title="起因"></a>起因</h1><p>LOC的大佬们最近开始疯狂的爬取mm131，作为一个Python初心者，作为技术上的学习，也要与时俱进，简单写了一个图片下载爬虫，看到大佬们似乎是做了一个typechoo的对接接口，我这边回头有空也搞一个wordpress的接口（只在博客内发布），之前写过一个新浪远程上传的接口，由于种种原因，新浪已经不支持外链了，因此这个wordpress接口可能就有时间再做了，不然做出来也是个摆设，没地方放。</p><h1 id="代码解析"><a href="#代码解析" class="headerlink" title="代码解析"></a>代码解析</h1><p>网址不发了，直接讲，或者大家直接百度谷歌都可以搜得到。<br>打开网站,总共有如下六个分类<br><figure class="image-bubble">                <div class="img-lightbox">                    <div class="overlay"></div>                    <img src="https://s2.ax1x.com/2019/06/18/VLAght.jpg" alt="mm131.jpg" title>                </div>                <div class="image-caption">mm131.jpg</div>            </figure><br>每个分类下面都有一堆的图集，有N个分页的图集，但是第一页跟第二页的地址还不太一样，这点跟192tt做的很相似，感觉这几个站长是不是都是用的同一套程序，如果是的话可以通杀了。。。<br>首先遍历图集的地址，到目前更新文章截止，一共大概5000多套<br>按分类给他搞一个分类循环</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">list = &#123;<span class="string">'xinggan'</span>:<span class="number">6</span>,<span class="string">'qingchun'</span>:<span class="number">1</span>,<span class="string">'xiaohua'</span>:<span class="number">2</span>,<span class="string">'chemo'</span>:<span class="number">3</span>,<span class="string">'qipao'</span>:<span class="number">4</span>,<span class="string">'mingxing'</span>:<span class="number">5</span>&#125;</span><br><span class="line">    <span class="comment"># list = &#123;'mingxing':5&#125;</span></span><br><span class="line">    <span class="keyword">for</span> key <span class="keyword">in</span> list:</span><br><span class="line">        getPageUrl(key,list[key])</span><br></pre></td></tr></table></figure><p>解析图片url，用正则获取就行，用bs4取到末页的地址，然后遍历循环取图集地址</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    i.find(<span class="string">'img'</span>).get(<span class="string">'src'</span>)</span><br><span class="line"><span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">    <span class="keyword">for</span> s <span class="keyword">in</span> i.find_all(<span class="string">'a'</span>):</span><br><span class="line">        endPage = s.get(<span class="string">'href'</span>)</span><br><span class="line">    endPage = rex(<span class="string">'list_%s_(\d+).html'</span>%num,endPage)</span><br><span class="line">    <span class="keyword">continue</span></span><br></pre></td></tr></table></figure><p>获取图集地址<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">nextUrl = <span class="string">"%s/list_%s_%s.html"</span>%(url,num,i+<span class="number">2</span>)</span><br><span class="line">response = requests.get(nextUrl, headers=headers)</span><br><span class="line">response.encoding = <span class="string">'gb2312'</span></span><br><span class="line">soup = BeautifulSoup(response.text, <span class="string">'html.parser'</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> soup.find(<span class="string">'dl'</span>, &#123;<span class="string">'class'</span>: <span class="string">'public-box'</span>&#125;).find_all(<span class="string">'dd'</span>):</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        i.find(<span class="string">'img'</span>).get(<span class="string">'src'</span>)</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line">    print(i.find(<span class="string">'a'</span>).get(<span class="string">'href'</span>))</span><br></pre></td></tr></table></figure></p><p>需要注意的是，mm131的图片是有防盗链的，根据referer判断，随便找一个图集的地址设置上即可<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">headers = &#123;</span><br><span class="line">    <span class="string">"User-Agent"</span>: <span class="string">"Mozilla/5.0 (Windows NT 6.1; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/74.0.3729.169 Safari/537.36"</span>,</span><br><span class="line">    <span class="string">'referer'</span>: <span class="string">"http://www.mm131.com/xinggan/4995.html"</span>,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h1 id="线程池应用"><a href="#线程池应用" class="headerlink" title="线程池应用"></a>线程池应用</h1><p>之前的爬虫除了Scrapy搞出来的之外都是单线程的爬虫，优点是比较稳定，但是缺点也很明显，太慢了，mm131这个站的图大都比较小，如果是一张一张下载确实是不太划算，于是搞了个线程池。<br>Python的线程池很简单，只需要引入 threadpool 即可，如果报错，请 pip install threadpool,<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 引入threadpool</span></span><br><span class="line"><span class="keyword">import</span> threadpool</span><br><span class="line"><span class="comment"># 创建线程池，设置为12线程，可以根据自身情况修改</span></span><br><span class="line">pool = threadpool.ThreadPool(<span class="number">12</span>)</span><br><span class="line"><span class="comment"># 创建callback函数，参数1 getSingleData 是需要调用的函数名，list是函数getSingleData的参数，该方法适用于单个参数的函数，list是一个一维数组或对象</span></span><br><span class="line">pageTask = threadpool.makeRequests(getSingleData, list)</span><br><span class="line"><span class="comment"># 执行线程池</span></span><br><span class="line">[pool.putRequest(req) <span class="keyword">for</span> req <span class="keyword">in</span> pageTask]</span><br><span class="line"><span class="comment"># 等待完成后退出</span></span><br><span class="line">pool.wait()</span><br></pre></td></tr></table></figure></p><h1 id="演示和下载"><a href="#演示和下载" class="headerlink" title="演示和下载"></a>演示和下载</h1><h3 id="演示图"><a href="#演示图" class="headerlink" title="演示图"></a>演示图</h3><figure class="image-bubble">                <div class="img-lightbox">                    <div class="overlay"></div>                    <img src="https://s2.ax1x.com/2019/06/18/VLE8v8.jpg" alt="多线程演示.jpg" title>                </div>                <div class="image-caption">多线程演示.jpg</div>            </figure><figure class="image-bubble">                <div class="img-lightbox">                    <div class="overlay"></div>                    <img src="https://s2.ax1x.com/2019/06/18/VLEhP1.jpg" alt="下载结果.jpg" title>                </div>                <div class="image-caption">下载结果.jpg</div>            </figure><h3 id="下载"><a href="#下载" class="headerlink" title="下载"></a>下载</h3><p>演示代码不全，直接上地址<br><a href="https://github.com/ai0by/ai0by-spider/tree/master/mm131" target="_blank" rel="noopener">https://github.com/ai0by/ai0by-spider/tree/master/mm131</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;起因&quot;&gt;&lt;a href=&quot;#起因&quot; class=&quot;headerlink&quot; title=&quot;起因&quot;&gt;&lt;/a&gt;起因&lt;/h1&gt;&lt;p&gt;LOC的大佬们最近开始疯狂的爬取mm131，作为一个Python初心者，作为技术上的学习，也要与时俱进，简单写了一个图片下载爬虫，看到大佬们
      
    
    </summary>
    
      <category term="Python" scheme="https://sbcoder.cn/categories/Python/"/>
    
    
      <category term="Python" scheme="https://sbcoder.cn/tags/Python/"/>
    
      <category term="爬虫" scheme="https://sbcoder.cn/tags/%E7%88%AC%E8%99%AB/"/>
    
      <category term="福利" scheme="https://sbcoder.cn/tags/%E7%A6%8F%E5%88%A9/"/>
    
  </entry>
  
  <entry>
    <title>Redis/Redis集群以及在Laravel中的使用方法</title>
    <link href="https://sbcoder.cn/2019/06/17/Redis_laravel_PHP.html"/>
    <id>https://sbcoder.cn/2019/06/17/Redis_laravel_PHP.html</id>
    <published>2019-06-17T13:19:37.000Z</published>
    <updated>2019-06-17T13:21:08.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="Redis的数据类型"><a href="#Redis的数据类型" class="headerlink" title="Redis的数据类型"></a>Redis的数据类型</h2><p>Redis也算是一种数据的容器，承载在内存上，因此它的各方面性能都比较快，且作为非关系型数据库，面对各种索引也比普通的数据库查询快，不同的场景下使用不同的数据类型，适用于很多地方</p><h3 id="字符串类型-String"><a href="#字符串类型-String" class="headerlink" title="字符串类型 String"></a>字符串类型 String</h3><p>一一对应，使用场景比较多 key:value 形式</p><table><thead><tr><th>命令</th><th>描述 </th></tr></thead><tbody><tr><td>set key value</td><td>设置指定key值</td></tr><tr><td>get key</td><td>获取指定key的value值</td></tr><tr><td>mget key1 key2</td><td>获取多个key 的 value，按顺序返回value值</td></tr><tr><td>mset key1 ‘value1’ key2 ‘value2’</td><td>批量设置多个key的value</td></tr><tr><td>strlen key</td><td>返回对应value长度</td></tr><tr><td>getrange key start end</td><td>截取字符串</td></tr><tr><td>append key value</td><td>追加key关联的value值，返回长度</td></tr><tr><td>getset key value</td><td>设置key的value并返回原value值</td></tr><tr><td>setex key time value</td><td>设置value值，并加上一个过期时间，使用ttl key查看过期时间，秒为单位</td></tr><tr><td>setnx key value</td><td>当key不存在时，设置value</td></tr><tr><td>msetnx key1 ‘value1’ key2 ‘value2’</td><td>当所有的key都不存在时，批量设置多个key的value</td></tr><tr><td>incr key</td><td>将key关联value的值加一，仅对数字有效</td></tr><tr><td>incrby key num</td><td>将key关联value的值加num，例如 10，仅对数字有效</td></tr><tr><td>incrbyflout key num</td><td>将key关联value的值加num，浮点类型</td></tr><tr><td>decr key</td><td>将key关联value的值减一，仅对数字有效</td></tr><tr><td>decrby key num</td><td>将key关联value的值减num，例如 10，仅对数字有效</td></tr></tbody></table><h3 id="哈希类型-Hash"><a href="#哈希类型-Hash" class="headerlink" title="哈希类型 Hash"></a>哈希类型 Hash</h3><p>一对一对多，类似字符串，但又区别于字符串，它比字符串复杂一些，同样是key:value，但是他的value可以是一个map，同时，它也无法给单个属性赋予过期时间，但可以给单个属性设置值，某些情况下比String占用资源少，当需要缓存整张表时推荐使用</p><table><thead><tr><th>命令</th><th>描述 </th></tr></thead><tbody><tr><td>hset key field value</td><td>设置key关联的value</td></tr><tr><td>hkeys key</td><td>获取所有的key</td></tr><tr><td>hgetall key</td><td>获取key的所有对应field</td></tr><tr><td>hvals key</td><td>获取hash表中所有的value</td></tr><tr><td>hlen key</td><td>获取keyd的长度</td></tr><tr><td>hmget key field1 field2</td><td>获取多个field的值</td></tr><tr><td>hmset key field1 value1 field2 value2</td><td>设置多个field的值</td></tr><tr><td>hdel key field</td><td>删除单个field的单个属性</td></tr><tr><td>hsetnx key field value</td><td>当field不存在时存储数值</td></tr><tr><td>hincrby key field num</td><td>给指定字段增加数值，整数</td></tr><tr><td>hincrbyfloat key field num</td><td>给指定字段增加浮点数</td></tr></tbody></table><h3 id="列表类型-List"><a href="#列表类型-List" class="headerlink" title="列表类型 List"></a>列表类型 List</h3><p>类似栈，拥有栈的特性，也有链表的特性，亦可用作消息队列等场景，使用场景很广</p><table><thead><tr><th>命令</th><th>描述 </th></tr></thead><tbody><tr><td>lpush key value1 value2</td><td>将多个value插入到关联的key里面 头部</td></tr><tr><td>lpushx key value</td><td>将value插入到key中，需要key已经存在 头部</td></tr><tr><td>lpop key</td><td>删除并获取当前key里面的第一个元素</td></tr><tr><td>llen key</td><td>获取当前key关联的list长度</td></tr><tr><td>rpush key value1 value2</td><td>将多个value插入到关联的key里面 尾部</td></tr><tr><td>rpop key</td><td>删除并获取列表内的最后一个元素</td></tr><tr><td>rpushx key value</td><td>将value插入到key中，需要key已经存在 尾部</td></tr><tr><td>blpop key1 key2    timeout</td><td>删除并获取列表的第一个元素，key1存在时不执行key2，如果没有会一直阻塞到弹出为止，建议添加延时</td></tr><tr><td>brpop key1 key2    timeout</td><td>删除并获取列表的最后一个元素，key1存在时不执行key2，如果没有会一直阻塞到弹出为止，建议添加延时</td></tr><tr><td>lindex key</td><td>通过索引来获取list中的元素</td></tr><tr><td>lset key index value</td><td>通过索引来设置相应元素的值</td></tr><tr><td>lrange key start end</td><td>截取指定列表内元素</td></tr><tr><td>ltrim key start end</td><td>只保留开始和结束内的元素</td></tr></tbody></table><h3 id="集合-set"><a href="#集合-set" class="headerlink" title="集合 set"></a>集合 set</h3><p>数据池，无序，可计算差集交集等，之前写爬虫时用集合做过去重，Python使用redis也是非常方便的</p><table><thead><tr><th>命令</th><th>描述 </th></tr></thead><tbody><tr><td>sadd key member1 member2</td><td>向集合内添加元素</td></tr><tr><td>scard key</td><td>获取集合内元素数量</td></tr><tr><td>smembers key</td><td>获取集合内所有的元素</td></tr><tr><td>sismember key member</td><td>判断member是否是key集合的子元素</td></tr><tr><td>sdiff key1 key2</td><td>获取给定集合的差集</td></tr><tr><td>sinter key1 key2</td><td>获取给定集合的交集</td></tr><tr><td>sunion key1 key2</td><td>获取给定集合的并集</td></tr><tr><td>spop key</td><td>随机删除一个集合内元素并返回</td></tr><tr><td>srandmember key num</td><td>返回集合内的一个或者多个随机元素</td></tr><tr><td>srem key member1 member2</td><td>删除集合中一个或者多个指定元素</td></tr></tbody></table><h3 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h3><p>剩下的数据类型确实是没用过，这里不便多说</p><h2 id="Laravel使用redis流程"><a href="#Laravel使用redis流程" class="headerlink" title="Laravel使用redis流程"></a>Laravel使用redis流程</h2><p>简单来说如下图所示<br><figure class="image-bubble">                <div class="img-lightbox">                    <div class="overlay"></div>                    <img src="https://i.loli.net/2019/06/17/5d07545d4a38c24666.jpg" alt="Laravel使用redis" title>                </div>                <div class="image-caption">Laravel使用redis</div>            </figure></p><p>程序将数据存储请求发送给Laravel内置的redis模块（PHPRedis，Predis等），并在config/database.php中配置好redis的端口密码等信息，通过内置模块调用已经安装好的redis即可使用redis存储使用数据了，然后redis内部处理数据<br>我们如果不做底层的话，正常存储使用，只需要处理好程序与Laravel之间的过程就可以了，也就是说，了解PHPRedis和Predis就可以了，目前似乎大多数人使用的都是这两种，也不仅限于Laravel，原生PHP以及像Swoole这种的也是可以使用的。</p><p>关于Laravel中的Redis配置使用 可以参考 <a href="https://learnku.com/docs/laravel/5.8/redis/3930" target="_blank" rel="noopener">Laravel中文文档5.8 - redis</a></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// laravel 简单调用示例</span></span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Support</span>\<span class="title">Facades</span>\<span class="title">Redis</span>;</span><br><span class="line">class testRedis()&#123;</span><br><span class="line">Redis::set(<span class="string">'username'</span>,<span class="string">'风向标'</span>);</span><br><span class="line">$username = Redis::get(<span class="string">'username'</span>);</span><br><span class="line"><span class="keyword">return</span> $username;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="Laravel使用Redis集群"><a href="#Laravel使用Redis集群" class="headerlink" title="Laravel使用Redis集群"></a>Laravel使用Redis集群</h2><p>仍然是在 config/database 中配置 clusters<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">'redis'</span> =&gt; [</span><br><span class="line"></span><br><span class="line">        <span class="string">'client'</span> =&gt; env(<span class="string">'REDIS_CLIENT'</span>, <span class="string">'predis'</span>),</span><br><span class="line"></span><br><span class="line">        <span class="string">'options'</span> =&gt; [</span><br><span class="line">            <span class="string">'cluster'</span> =&gt; env(<span class="string">'REDIS_CLUSTER'</span>, <span class="string">'predis'</span>),</span><br><span class="line">            <span class="comment">// 'cluster' =&gt; env('redis'),</span></span><br><span class="line">        ],</span><br><span class="line"></span><br><span class="line">        <span class="string">'clusters'</span> =&gt; [                                                                             </span><br><span class="line">        <span class="string">'vaneCache'</span> =&gt; [                                                                       </span><br><span class="line">            [                                                                                   </span><br><span class="line">                <span class="string">'host'</span> =&gt; env(<span class="string">'REDIS_HOST'</span>, <span class="string">'127.0.0.1'</span>),                                       </span><br><span class="line">                <span class="string">'password'</span> =&gt; env(<span class="string">'REDIS_PASSWORD'</span>, <span class="keyword">null</span>),                                      </span><br><span class="line">                <span class="string">'port'</span> =&gt; env(<span class="string">'REDIS_PORT'</span>, <span class="number">6379</span>),                                              </span><br><span class="line">                <span class="string">'database'</span> =&gt; <span class="number">1</span>,                                                                </span><br><span class="line">            ],                                                                                  </span><br><span class="line">            [                                                                                   </span><br><span class="line">                <span class="string">'host'</span> =&gt; env(<span class="string">'REDIS_HOST'</span>, <span class="string">'127.0.0.1'</span>),                                       </span><br><span class="line">                <span class="string">'password'</span> =&gt; env(<span class="string">'REDIS_PASSWORD'</span>, <span class="keyword">null</span>),                                      </span><br><span class="line">                <span class="string">'port'</span> =&gt; env(<span class="string">'REDIS_PORT'</span>, <span class="number">6379</span>),                                              </span><br><span class="line">                <span class="string">'database'</span> =&gt; <span class="number">2</span>,                                                                </span><br><span class="line">            ],</span><br><span class="line">            [                                                                                   </span><br><span class="line">                <span class="string">'host'</span> =&gt; env(<span class="string">'REDIS_HOST'</span>, <span class="string">'127.0.0.1'</span>),                                       </span><br><span class="line">                <span class="string">'password'</span> =&gt; env(<span class="string">'REDIS_PASSWORD'</span>, <span class="keyword">null</span>),                                      </span><br><span class="line">                <span class="string">'port'</span> =&gt; env(<span class="string">'REDIS_PORT'</span>, <span class="number">6379</span>),                                              </span><br><span class="line">                <span class="string">'database'</span> =&gt; <span class="number">3</span>,                                                                </span><br><span class="line">            ], </span><br><span class="line">       ],</span><br><span class="line">   ],</span><br><span class="line"></span><br><span class="line">    ],</span><br></pre></td></tr></table></figure></p><p>在使用时仅需要 使用 connection 即可</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$redis1 = Redis::connection(<span class="string">'vaneCache'</span>);</span><br><span class="line">$redis1-&gt;set(<span class="string">'username'</span>,<span class="string">'风向标'</span>);</span><br><span class="line">$username = $redis1-&gt;get(<span class="string">'username'</span>);</span><br><span class="line"><span class="keyword">echo</span> $username;</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;Redis的数据类型&quot;&gt;&lt;a href=&quot;#Redis的数据类型&quot; class=&quot;headerlink&quot; title=&quot;Redis的数据类型&quot;&gt;&lt;/a&gt;Redis的数据类型&lt;/h2&gt;&lt;p&gt;Redis也算是一种数据的容器，承载在内存上，因此它的各方面性能都比较快，且
      
    
    </summary>
    
      <category term="PHP" scheme="https://sbcoder.cn/categories/PHP/"/>
    
    
      <category term="优化" scheme="https://sbcoder.cn/tags/%E4%BC%98%E5%8C%96/"/>
    
      <category term="PHP" scheme="https://sbcoder.cn/tags/PHP/"/>
    
      <category term="Laravel" scheme="https://sbcoder.cn/tags/Laravel/"/>
    
      <category term="Redis" scheme="https://sbcoder.cn/tags/Redis/"/>
    
  </entry>
  
  <entry>
    <title>tuwan（兔玩）全站妹子图爬虫可多窗口</title>
    <link href="https://sbcoder.cn/2019/05/13/tuwan_spider.html"/>
    <id>https://sbcoder.cn/2019/05/13/tuwan_spider.html</id>
    <published>2019-05-13T15:01:00.000Z</published>
    <updated>2019-05-13T15:29:23.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>兔玩是一个非常不错的妹子图网站，跟曾经的PR社有异曲同工之处，花少量的钱可以看Coser的图片，但是tuwan的妹子还是很正经的哟~<br>兔玩官网 <a href="https://www.tuwanjun.com/" target="_blank" rel="noopener">tuwanjun.com</a><br>以下是网站截图<br><figure class="image-bubble">                <div class="img-lightbox">                    <div class="overlay"></div>                    <img src="https://i.loli.net/2019/05/13/5cd987f05d3b167053.jpg" alt="tuwan" title>                </div>                <div class="image-caption">tuwan</div>            </figure><br>兔玩的更新速度还是不错的呢~</p><h2 id="破解"><a href="#破解" class="headerlink" title="破解"></a>破解</h2><p>看到官网的套图打开后，一般是有几张可以看得图，也有一堆尺寸小的预览图，地址很相似，例如这张<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://img4.tuwandata.com/v3/thumb/jpg/YjAzYiwxNTgsMTU4LDksMywxLC0xLE5PTkUsLCw5MA==/u/GLDM9lMIBglnFv7YKftLBuvzpwYbEIoBh8ap84BsgXdniTdx80UqsXLdP5yaJZklUj09PvGO8IYpAC3nOanE0EHpB9bCnRKUnvdbAJH6CcXC.jpg</span><br></pre></td></tr></table></figure></p><p><font color="#FF0000">YjAzYiwxNTgsMTU4LDksMywxLC0xLE5PTkUsLCw5MA==</font>这一串很容易看的出是base64加密过的串，经过解密获得<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">base64.b64decode(imgurl)</span><br><span class="line"><span class="comment"># b03b,158,158,9,3,1,-1,NONE,,,90</span></span><br></pre></td></tr></table></figure></p><p>这里的158,158就是缩略图的尺寸了，我们尝试修改缩略图尺寸然后在base64加密后就可以取得地址，经过尝试，修改为 0，0即可还原原图尺寸~<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">base64.b64encode(base64.b64decode(imgurl.encode(<span class="string">'utf-8'</span>)).replace(<span class="string">'158'</span>,<span class="string">'0'</span>))</span><br><span class="line"><span class="comment"># YjAzYiwwLDAsOSwzLDEsLTEsTk9ORSwsLDkw</span></span><br></pre></td></tr></table></figure></p><p>组合成原图地址：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://img4.tuwandata.com/v3/thumb/jpg/YjAzYiwwLDAsOSwzLDEsLTEsTk9ORSwsLDkw/u/GLDM9lMIBglnFv7YKftLBuvzpwYbEIoBh8ap84BsgXdniTdx80UqsXLdP5yaJZklUj09PvGO8IYpAC3nOanE0EHpB9bCnRKUnvdbAJH6CcXC.jpg</span><br></pre></td></tr></table></figure></p><h2 id="下载"><a href="#下载" class="headerlink" title="下载"></a>下载</h2><p>源代码已经开源到Github上了<br>上一张测试图<br><figure class="image-bubble">                <div class="img-lightbox">                    <div class="overlay"></div>                    <img src="https://i.loli.net/2019/05/13/5cd98d4c726e038815.jpeg" alt="测试图" title>                </div>                <div class="image-caption">测试图</div>            </figure></p><p>下载地址：<a href="https://github.com/ai0by/ai0by-spider/tree/master/tuwan" target="_blank" rel="noopener">tuwan_spider</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h2&gt;&lt;p&gt;兔玩是一个非常不错的妹子图网站，跟曾经的PR社有异曲同工之处，花少量的钱可以看Coser的图片，但是tuwan的妹子还是很正经的哟~&lt;br&gt;
      
    
    </summary>
    
      <category term="Python" scheme="https://sbcoder.cn/categories/Python/"/>
    
    
      <category term="Python" scheme="https://sbcoder.cn/tags/Python/"/>
    
      <category term="爬虫" scheme="https://sbcoder.cn/tags/%E7%88%AC%E8%99%AB/"/>
    
      <category term="福利" scheme="https://sbcoder.cn/tags/%E7%A6%8F%E5%88%A9/"/>
    
  </entry>
  
  <entry>
    <title>Discuz会员数据与Wordpress互通</title>
    <link href="https://sbcoder.cn/2019/04/11/Discuz-Userinfo-To-Wordpress.html"/>
    <id>https://sbcoder.cn/2019/04/11/Discuz-Userinfo-To-Wordpress.html</id>
    <published>2019-04-11T12:06:06.000Z</published>
    <updated>2019-05-13T14:57:58.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="情景"><a href="#情景" class="headerlink" title="情景"></a>情景</h2><p>这个情景可能遇到的也不在少数，不想舍弃用户数据，还想让用户无需注册在新站保留账号。<br>实际当我们在迁移的时候，稍微了解数据库的同学应该明白想要迁移用户数据只需要迁移用户数据表即可。<br>实际上我也是这么做的，但是中途遇到了几个小问题，这里我总结一下！</p><h2 id="Discuz用户密码加密算法"><a href="#Discuz用户密码加密算法" class="headerlink" title="Discuz用户密码加密算法"></a>Discuz用户密码加密算法</h2><p>Discuz的用户信息都存放在 ‘<font color="#FF0000">pre_common_member</font>‘  表里，包含了我们需要转移的 邮箱,用户名,密码,积分,ip 等各类信息<br>那么很简单了，便利这个表再插入到Wordpress表内即可<br>但在导入表之前需要先测试一下用户数据是否匹配以示严谨~<br>当我测试密码匹配的时候发现，这里的密码似乎并不匹配，首先我想到的就是应该是加盐了，但是纵观整个 ‘<font color="#FF0000">pre_common_member</font>‘ 表，似乎并没有该有的字段<br>网上找了一圈发现Discuz的用户真实密码是存在 ‘<font color="#FF0000">pre_ucenter_members</font>‘ 表内的，’<font color="#FF0000">pre_common_member</font>‘ 表内的密码我现在还不知道有什么用处，但至少跟我们需要迁移的数据没什么关联。<br>从  ‘<font color="#FF0000">pre_ucenter_members</font>‘ 表中找到了我们需要的 ‘<font color="#FF0000">salt</font>‘ 字段，经过测试得出Discuz的密码加密算法为<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">md5(md5(<span class="string">'password'</span>).<span class="string">'salt'</span>);</span><br></pre></td></tr></table></figure></p><p>tips: Discuz里面的salt是一个6位的 数字+字母 随机数</p><h2 id="Wordpress用户密码加密算法"><a href="#Wordpress用户密码加密算法" class="headerlink" title="Wordpress用户密码加密算法"></a>Wordpress用户密码加密算法</h2><p>搞定了DZ的加密算法后，那么如何将DZ的用户信息插入到WP里面就很重要了，打开 Wordpress 的数据库找到 ‘<font color="#FF0000">wp-user</font>‘表，找到 ‘<font color="#FF0000">user_pass</font>‘ 字段，发现里面加密的内容似乎无迹可寻。<br>实际上，Wordpress的加密是使用了 phpass 类来加密的，由 phpass 加密的密码具有不可逆性，所以想要破解是不可能了，这里简单说一下 phpass 的加密算法<br>目前我们的PHP版本应该都在5以上，所以前缀是一样的 $P$B 大致写出来如下：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$count = rand(<span class="number">1</span>,<span class="number">8</span>);</span><br><span class="line">$hash = md5($salt . $password, <span class="keyword">TRUE</span>);</span><br><span class="line"><span class="keyword">while</span>($count--)&#123;</span><br><span class="line">$hash = md5($hash . $password, <span class="keyword">TRUE</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>看起来是不是很强，我们无法破解这样的密码，实际使用中，我们也可以使用 phpass 来做密码加密，让我们的数据库更加的安全~<br>然而我们数据迁移时其实完全可以避免这种问题，Wordpress是保留了md5加密的形式的，如果 ‘<font color="#FF0000">user_pass</font>‘ 字段里面存储的是md5加密的32值，wordpress也可以登录成功，并且再登陆后会将 ‘<font color="#FF0000">user_pass</font>‘ 字段修改为 phpass 加密的格式，是不是很人性化呢。<br>综上所述，我们无需解出来wordpress的加密算法，我们也解不出来~</p><h2 id="开始迁移用户数据"><a href="#开始迁移用户数据" class="headerlink" title="开始迁移用户数据"></a>开始迁移用户数据</h2><p>关于迁移有很多细节，本来是打算写出来的，后来发现没什么技术含量，都是流水账，直接开源到github好了<br>需要的朋友请直接点击 <a href="https://github.com/ai0by/D2W" target="_blank" rel="noopener">D2W - Github</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;情景&quot;&gt;&lt;a href=&quot;#情景&quot; class=&quot;headerlink&quot; title=&quot;情景&quot;&gt;&lt;/a&gt;情景&lt;/h2&gt;&lt;p&gt;这个情景可能遇到的也不在少数，不想舍弃用户数据，还想让用户无需注册在新站保留账号。&lt;br&gt;实际当我们在迁移的时候，稍微了解数据库的同学应该明
      
    
    </summary>
    
      <category term="PHP" scheme="https://sbcoder.cn/categories/PHP/"/>
    
    
      <category term="Discuz" scheme="https://sbcoder.cn/tags/Discuz/"/>
    
      <category term="Wordpress" scheme="https://sbcoder.cn/tags/Wordpress/"/>
    
  </entry>
  
  <entry>
    <title>192TT(192tb)套图吧整站爬虫</title>
    <link href="https://sbcoder.cn/2019/03/28/192tt_Spider.html"/>
    <id>https://sbcoder.cn/2019/03/28/192tt_Spider.html</id>
    <published>2019-03-28T08:15:16.000Z</published>
    <updated>2020-05-17T05:22:15.811Z</updated>
    
    <content type="html"><![CDATA[<h2 id="观察目录结构"><a href="#观察目录结构" class="headerlink" title="观察目录结构"></a>观察目录结构</h2><p>目标网站：192tb.com<br>网站结构复杂，但也不是太复杂，总体来说都写在导航栏上面了，本以为是new分类下就是所有的文章了，后来发现不是，需要遍历整个导航分类，由于每个分类都有很庞大的资源，因此我决定写成配置文件的形式，建立config.py</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line">mt  = <span class="string">'https://www.192tb.com/listinfo-1-1.html'</span>                  <span class="comment"># 美图</span></span><br><span class="line">mt1 = <span class="string">'https://www.192tb.com/meitu/xingganmeinv/'</span>  <span class="comment"># 性感美女</span></span><br><span class="line">mt2 = <span class="string">'https://www.192tb.com/meitu/siwameitui/'</span>    <span class="comment"># 丝袜美腿</span></span><br><span class="line">mt3 = <span class="string">'https://www.192tb.com/meitu/weimeixiezhen/'</span> <span class="comment"># 唯美写真</span></span><br><span class="line">mt4 = <span class="string">'https://www.192tb.com/meitu/wangluomeinv/'</span>  <span class="comment"># 网络美女</span></span><br><span class="line">mt5 = <span class="string">'https://www.192tb.com/meitu/gaoqingmeinv/'</span>  <span class="comment"># 高清美女</span></span><br><span class="line">mt6 = <span class="string">'https://www.192tb.com/meitu/motemeinv/'</span>     <span class="comment"># 模特美女</span></span><br><span class="line">mt7 = <span class="string">'https://www.192tb.com/meitu/tiyumeinv/'</span>     <span class="comment"># 体育美女</span></span><br><span class="line">mt8 = <span class="string">'https://www.192tb.com/meitu/dongmanmeinv/'</span>  <span class="comment"># 动漫美女</span></span><br><span class="line">mt9 = <span class="string">'https://www.192tb.com/new/ugirlapp/'</span>        <span class="comment"># 爱尤物APP/尤果网</span></span><br><span class="line"></span><br><span class="line">gc  = <span class="string">'https://www.192tb.com/gc/'</span>                   <span class="comment"># 国产</span></span><br><span class="line">gc1 = <span class="string">'https://www.192tb.com/gc/bl/'</span> <span class="comment"># beautyleg1</span></span><br></pre></td></tr></table></figure><p>顶级分类和二级分类不便多说，这里只是测试并没有收录所有的分类，有兴趣可以自己添加</p><p>进入分类页后既是套图封面，从这里可以爬取套图的链接，分类页的底部也是有下一页的选项，可以根据下一页来获取下一个分类页的链接，以此递归，并获取链接</p><p>获取到套图链接后发现每个单页面都是需要点击下一张图片来做的，单页面中的图片，使用BeautifulSoup即可轻松获取，由于不知道一套图里面有多少张，我这边使用递归的方式，走到最后一张，即退出递归。</p><h2 id="核心代码"><a href="#核心代码" class="headerlink" title="核心代码"></a>核心代码</h2><h3 id="获取单个套图并下载"><a href="#获取单个套图并下载" class="headerlink" title="获取单个套图并下载"></a>获取单个套图并下载</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">getSingleData</span><span class="params">(url,singleTitle,i = <span class="number">1</span>)</span>:</span></span><br><span class="line">    response = requests.get(url)</span><br><span class="line">    soup = BeautifulSoup(response.text,<span class="string">"html.parser"</span>)</span><br><span class="line">    imgUrl = soup.find(id = <span class="string">'p'</span>).find(<span class="string">'center'</span>).find(<span class="string">'img'</span>).get(<span class="string">'lazysrc'</span>)</span><br><span class="line">    <span class="keyword">print</span> imgUrl</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        j = i + <span class="number">1</span></span><br><span class="line">        result = <span class="string">'_%s.html'</span>%i <span class="keyword">in</span> url</span><br><span class="line">        <span class="keyword">if</span> result:</span><br><span class="line">            nextImg = response.url.replace(<span class="string">'_%s.html'</span>%i, <span class="string">'_%s.html'</span>%j)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            nextImg = response.url.replace(<span class="string">'.html'</span>, <span class="string">'_%s.html'</span>%j)</span><br><span class="line">        <span class="comment"># print nextImg</span></span><br><span class="line">        downImg(imgUrl,singleTitle,i)</span><br><span class="line">        getSingleData(nextImg,j)</span><br><span class="line">    <span class="keyword">except</span> Exception,e:</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span></span><br></pre></td></tr></table></figure><h3 id="获取下一页页面信息"><a href="#获取下一页页面信息" class="headerlink" title="获取下一页页面信息"></a>获取下一页页面信息</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">getPage</span><span class="params">(url,new = <span class="number">1</span>,i = <span class="number">1</span>)</span>:</span></span><br><span class="line">    <span class="keyword">print</span> <span class="string">'开始采集第%s页'</span>%i</span><br><span class="line">    <span class="keyword">print</span> url</span><br><span class="line">    response = requests.get(url)</span><br><span class="line">    soup = BeautifulSoup(response.text,<span class="string">"html.parser"</span>)</span><br><span class="line">    <span class="keyword">for</span> dataUrl <span class="keyword">in</span> soup.find(<span class="string">'div'</span>,&#123;<span class="string">'class'</span>:<span class="string">'piclist'</span>&#125;).find(<span class="string">'ul'</span>).find_all(<span class="string">'li'</span>):</span><br><span class="line">        singleDataUrl = <span class="string">'https://www.192tb.com/'</span>+dataUrl.find(<span class="string">'a'</span>).get(<span class="string">'href'</span>)</span><br><span class="line">        <span class="keyword">print</span> singleDataUrl</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            singleTitle = dataUrl.find(<span class="string">'a'</span>).find(<span class="string">'img'</span>).get(<span class="string">'alt'</span>)</span><br><span class="line">        <span class="keyword">except</span> Exception,e:</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        <span class="keyword">print</span> singleTitle</span><br><span class="line">        getSingleData(singleDataUrl,singleTitle)</span><br><span class="line">    result = <span class="string">'_%s.html'</span> % i <span class="keyword">in</span> url</span><br><span class="line">    j = i + <span class="number">1</span></span><br><span class="line">    <span class="keyword">if</span> new != <span class="number">1</span>:</span><br><span class="line">        nextPageUrl = url.replace(<span class="string">'listinfo-1-%s.html'</span> % i, <span class="string">'listinfo-1-%s.html'</span> % j)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">if</span> result:</span><br><span class="line">            nextPageUrl = url.replace(<span class="string">'index_%s.html'</span> % i, <span class="string">'index_%s.html'</span> % j)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            nextPageUrl = url.replace(url, url+<span class="string">'/index_%s.html'</span> % j)</span><br><span class="line">    getPage(nextPageUrl,new,j)</span><br></pre></td></tr></table></figure><h2 id="演示及下载"><a href="#演示及下载" class="headerlink" title="演示及下载"></a>演示及下载</h2><p>下载地址：<a href="https://github.com/ai0by/ai0by-spider/tree/master/192tt" target="_blank" rel="noopener">Github</a></p><figure class="image-bubble">                <div class="img-lightbox">                    <div class="overlay"></div>                    <img src="http://qiniu.xnbox.cn/2019/03/29/5c9dba3205190.png" alt="192tt演示图" title>                </div>                <div class="image-caption">192tt演示图</div>            </figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;观察目录结构&quot;&gt;&lt;a href=&quot;#观察目录结构&quot; class=&quot;headerlink&quot; title=&quot;观察目录结构&quot;&gt;&lt;/a&gt;观察目录结构&lt;/h2&gt;&lt;p&gt;目标网站：192tb.com&lt;br&gt;网站结构复杂，但也不是太复杂，总体来说都写在导航栏上面了，本以为是new
      
    
    </summary>
    
      <category term="Python" scheme="https://sbcoder.cn/categories/Python/"/>
    
    
      <category term="Python" scheme="https://sbcoder.cn/tags/Python/"/>
    
      <category term="爬虫" scheme="https://sbcoder.cn/tags/%E7%88%AC%E8%99%AB/"/>
    
      <category term="福利" scheme="https://sbcoder.cn/tags/%E7%A6%8F%E5%88%A9/"/>
    
  </entry>
  
  <entry>
    <title>正则表达式应用，常用取值表（记录）</title>
    <link href="https://sbcoder.cn/2019/03/26/Regex_match_note.html"/>
    <id>https://sbcoder.cn/2019/03/26/Regex_match_note.html</id>
    <published>2019-03-26T08:11:06.000Z</published>
    <updated>2019-03-27T03:50:12.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="正则表达式-查询表"><a href="#正则表达式-查询表" class="headerlink" title="正则表达式 查询表"></a>正则表达式 查询表</h2><table><thead><tr><th>字符</th><th>描述</th><th>场景  </th></tr></thead><tbody><tr><td> \</td><td>转义</td><td>转义场景 \</td></tr><tr><td>^</td><td>匹配输入字符串的开始位置。如果设置了 RegExp 对象的 Multiline 属性，^ 也匹配 ‘\n’ 或 ‘\r’ 之后的位置。</td><td>取a开头的字符串 ^a.*</td></tr><tr><td>$</td><td>匹配输入字符串的结束位置。如果设置了RegExp 对象的 Multiline 属性，$ 也匹配 ‘\n’ 或 ‘\r’ 之前的位置。</td><td>取a开头b结尾 ^a.*b$</td></tr><tr><td>*</td><td>匹配前面的子表达式零次或多次。</td><td>zo<em> 能匹配 “z” 以及 “zoo”。</em> 等价于{0,}</td></tr><tr><td>+</td><td>匹配前面的子表达式一次或多次。</td><td>‘zo+’ 能匹配 “zo” 以及 “zoo”，但不能匹配 “z”。+ 等价于 {1,}</td></tr><tr><td>?</td><td>匹配前面的子表达式零次或一次.</td><td>“do(es)?” 可以匹配 “do” 或 “does” 中的”do” 。? 等价于 {0,1}。</td></tr><tr><td>{n}</td><td>n 是一个非负整数。匹配确定的 n 次。</td><td>‘o{2}’ 不能匹配 “Bob” 中的 ‘o’，但是能匹配 “food” 中的两个 o。</td></tr><tr><td>{n,}</td><td>n 是一个非负整数。至少匹配n 次。</td><td>‘o{2,}’ 不能匹配 “Bob” 中的 ‘o’，但能匹配 “foooood” 中的所有 o。’o{1,}’ 等价于 ‘o+’。’o{0,}’ 则等价于 ‘o*’</td></tr><tr><td>{n,m}</td><td>m 和 n 均为非负整数，其中n &lt;= m。最少匹配 n 次且最多匹配 m 次。</td><td>“o{1,3}” 将匹配 “fooooood” 中的前三个 o。’o{0,1}’ 等价于 ‘o?’。请注意在逗号和两个数之间不能有空格。</td></tr><tr><td>?</td><td>当 该字符紧跟在任何一个其他限制符 (*, +, ?, {n}, {n,}, {n,m}) 后面时，匹配模式是非贪婪的。</td><td>非贪婪模式尽可能少的匹配所搜索的字符串，而默认的贪婪模式则尽可能多的匹配所搜索的字符串。对于字符串 “oooo”，’o+?’ 将匹配单个 “o”，而 ‘o+’ 将匹配所有 ‘o’。</td></tr><tr><td>.</td><td>匹配除 “\n” 之外的任何单个字符。</td><td>要匹配包括 ‘\n’ 在内的任何字符，请使用象 ‘[.\n]’ 的模式。</td></tr><tr><td>x&#124;y</td><td>匹配 x 或 y。</td><td>‘z&#124;food’ 能匹配 “z” 或 “food”。’(z&#124;f)ood’ 则匹配 “zood” 或 “food”。</td></tr><tr><td>[xyz]</td><td>字符集合。匹配所包含的任意一个字符。</td><td>‘[abc]’可以匹配 “plain” 中的 ‘a’。</td></tr><tr><td>[^xyz]</td><td>取反，匹配未包含的任意字符。</td><td>‘?[^abc]’ 可以匹配 “plain” 中的’p’。</td></tr><tr><td>[a-z]</td><td>字符范围。匹配指定范围内的任意字符。</td><td>‘[a-z]’ 可以匹配 ‘a’ 到 ‘z’ 范围内的任意小写字母字符。</td></tr><tr><td>\b</td><td>匹配一个单词边界，也就是指单词和空格间的位置。</td><td>‘er\b’ 可以匹配”never” 中的 ‘er’，但不能匹配 “verb” 中的 ‘er’。</td></tr><tr><td>\B</td><td>匹配非单词边界</td><td>‘er\B’ 能匹配 “verb” 中的 ‘er’，但不能匹配 “never” 中的 ‘er’。</td></tr><tr><td>\cx</td><td>匹配由 x 指明的控制字符。</td><td>\cM 匹配一个 Control-M 或回车符。x 的值必须为 A-Z 或 a-z 之一。否则，将 c 视为一个原义的 ‘c’ 字符。</td></tr><tr><td>\d</td><td>匹配一个数字字符</td><td>等价于 [0-9]。</td></tr><tr><td>\D</td><td>匹配一个非数字字符。</td><td>等价于 [^0-9]。</td></tr><tr><td>\f</td><td>匹配一个换页符。</td><td>等价于 \x0c 和 \cL。</td></tr><tr><td>\n</td><td>匹配一个换行符。</td><td>等价于 \x0a 和 \cJ。</td></tr><tr><td>\r</td><td>匹配一个回车符。</td><td>等价于 \x0d 和 \cM。</td></tr><tr><td>\s</td><td>匹配任何空白字符，包括空格、制表符、换页符等等。</td><td>等价于 [ \f\n\r\t\v]。</td></tr><tr><td>\S</td><td>匹配任何非空白字符。</td><td>等价于 [^ \f\n\r\t\v]。</td></tr><tr><td>\t</td><td>匹配一个制表符。</td><td>等价于 \x09 和 \cI。</td></tr><tr><td>\v</td><td>匹配一个垂直制表符。</td><td>等价于 \x0b 和 \cK。</td></tr><tr><td>\w</td><td>匹配包括下划线的任何单词字符。</td><td>等价于’[A-Za-z0-9_]’。</td></tr><tr><td>\W</td><td>匹配任何非单词字符。</td><td>等价于 ‘[^A-Za-z0-9_]’。</td></tr><tr><td>\xn</td><td>匹配十六进制数</td><td>‘\x41’ 匹配 “A”。’\x041’ 则等价于 ‘\x04’ &amp; “1”。正则表达式中可以使用 ASCII 编码。.</td></tr><tr><td>\num</td><td>匹配 一个正整数。对所获取的匹配的引用。</td><td>‘(.)\1’ 匹配两个连续的相同字符。</td></tr><tr><td>\n</td><td>标识一个八进制转义值或一个向后引用。</td><td>如果 \n 之前至少 n 个获取的子表达式，则 n 为向后引用。否则，如果 n 为八进制数字 (0-7)，则 n 为一个八进制转义值。</td></tr><tr><td>\nm</td><td>标 识一个八进制转义值或一个向后引用。</td><td>如果 \nm 之前至少有 nm 个获得子表达式，则 nm 为向后引用。如果 \nm 之前至少有 n 个获取，则 n 为一个后跟文字 m 的向后引用。如果前面的条件都不满足，若 n 和 m 均为八进制数字 (0-7)，则 \nm 将匹配八进制转义值 nm。</td></tr><tr><td>\nml</td><td>匹配八进制数</td><td>如果 n 为八进制数字 (0-3)，且 m 和 l 均为八进制数字 (0-7)，则匹配八进制转义值 nml。</td></tr><tr><td>\un</td><td>匹配 n，其中 n 是一个用四个十六进制数字表示的 Unicode 字符。</td><td>\u00A9 匹配版权符号 。</td></tr></tbody></table><h2 id="常用案例演示"><a href="#常用案例演示" class="headerlink" title="常用案例演示"></a>常用案例演示</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line">str1 = <span class="string">'ai0by123'</span></span><br></pre></td></tr></table></figure><p>提取a开头的字符串<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">regexStr = <span class="string">"^a.*"</span></span><br></pre></td></tr></table></figure></p><p>提取a开头b结尾字符串<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">regexStr = <span class="string">"^a.*3$"</span></span><br></pre></td></tr></table></figure></p><p>提取最右边符合条件的值,贪婪<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">regexStr = <span class="string">".*(a.*b).*"</span>             <span class="comment"># 贪婪，取a到b之间，右边开始取，取最右边符合条件的</span></span><br></pre></td></tr></table></figure></p><p>提取最左边符合条件的值，非贪婪<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">regexStr = <span class="string">".*?(a.*?b).*"</span>           <span class="comment"># 非贪婪，取a到b之间的值含a和b，从左往右只取一次</span></span><br></pre></td></tr></table></figure></p><p>提取符合集合内的值，或运算<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">regexStr = <span class="string">"((ai00000by|ai0by)123)"</span> <span class="comment"># 或运算，符合其中一种即可</span></span><br></pre></td></tr></table></figure></p><p>提取出生日期<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">str1 = <span class="string">'XXX 出生于2008年12月6日'</span></span><br><span class="line">str1 = <span class="string">'XXX 出生于2008/12/6'</span></span><br><span class="line">str1 = <span class="string">'XXX 出生于2008-12-6'</span></span><br><span class="line">str1 = <span class="string">'XXX 出生于2008-12-06'</span></span><br><span class="line">str1 = <span class="string">'XXX 出生于2008-12'</span></span><br><span class="line">regexStr = <span class="string">".*出生于(\d&#123;4&#125;[年/-]\d&#123;1,2&#125;([月/-]\d&#123;1,2&#125;|[月/-]$|$))"</span></span><br></pre></td></tr></table></figure></p><p>提取图片url,其他网站同理<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">str1 = <span class="string">'地址：https://www.ttbcdn.com/d/file/p/2018-02-17/g4edlvxmmyi9627.jpg'</span></span><br><span class="line"><span class="comment"># 取整串地址</span></span><br><span class="line">regexStr = <span class="string">".*https.*jpg$"</span></span><br><span class="line"><span class="comment"># 取XXX.jpg png gif 等</span></span><br><span class="line">regexStr = <span class="string">".*/(.*.(jpg|gif|png))$"</span></span><br><span class="line"><span class="comment"># 取2018-02-17/g4edlvxmmyi9627.jpg png gif等</span></span><br><span class="line">regexStr = <span class="string">".*/(\d&#123;4&#125;-\d&#123;2&#125;-\d&#123;2&#125;/(.*.(jpg|gif|png)))$"</span></span><br></pre></td></tr></table></figure></p><h2 id="收尾提取字符串"><a href="#收尾提取字符串" class="headerlink" title="收尾提取字符串"></a>收尾提取字符串</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">reMatch = re.match(regexStr,str1)</span><br><span class="line"><span class="keyword">if</span> reMatch:</span><br><span class="line"><span class="keyword">print</span> (reMatch.group(<span class="number">1</span>))</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">print(<span class="string">'No'</span>)</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;正则表达式-查询表&quot;&gt;&lt;a href=&quot;#正则表达式-查询表&quot; class=&quot;headerlink&quot; title=&quot;正则表达式 查询表&quot;&gt;&lt;/a&gt;正则表达式 查询表&lt;/h2&gt;&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;字符&lt;/th&gt;
&lt;th&gt;描述&lt;/th&gt;

      
    
    </summary>
    
      <category term="note" scheme="https://sbcoder.cn/categories/note/"/>
    
    
      <category term="笔记" scheme="https://sbcoder.cn/tags/%E7%AC%94%E8%AE%B0/"/>
    
      <category term="正则表达式" scheme="https://sbcoder.cn/tags/%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F/"/>
    
  </entry>
  
</feed>
